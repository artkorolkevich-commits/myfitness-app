<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Настройки</title>
    <style>
      :root {
        --bg: #0f172a;
        --card: #111827;
        --text: #e5e7eb;
        --muted: #94a3b8;
        --accent: #22c55e;
        --warn: #f59e0b;
        --danger: #ef4444;
        --yandex: #fc3f1d;
      }
      * { box-sizing: border-box; }
      html, body {
        margin: 0;
        padding: 0;
        background: var(--bg);
        color: var(--text);
        font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        line-height: 1.6;
      }
      
      .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 24px;
      }
      
      .header {
        margin-bottom: 24px;
      }
      
      .header h1 {
        margin: 0 0 8px;
        font-size: 28px;
        font-weight: 600;
      }
      
      .header p {
        margin: 0;
        color: var(--muted);
        font-size: 16px;
      }
      
      /* Settings Sections */
      .settings-section {
        background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
        border: 1px solid rgba(148, 163, 184, 0.2);
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
      }
      
      .settings-section h3 {
        margin: 0 0 16px;
        font-size: 18px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .section-icon {
        font-size: 20px;
      }
      
      /* Form Groups */
      .form-group {
        margin-bottom: 20px;
      }
      
      .form-group label {
        display: block;
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 6px;
        color: var(--text);
      }
      
      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        background: #0b1220;
        color: var(--text);
        border: 1px solid rgba(148,163,184,0.25);
        border-radius: 8px;
        padding: 10px 12px;
        font-size: 14px;
        outline: none;
        transition: border-color 0.2s ease;
      }
      
      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 2px rgba(34,197,94,0.2);
      }
      
      .form-group .help-text {
        font-size: 12px;
        color: var(--muted);
        margin-top: 4px;
      }
      
      /* Buttons */
      .btn {
        background: linear-gradient(180deg, var(--accent), #16a34a);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 10px 16px;
        font-size: 14px;
        cursor: pointer;
        transition: transform 0.2s ease;
      }
      
      .btn:hover {
        transform: translateY(-1px);
      }
      
      .btn-secondary {
        background: linear-gradient(180deg, #6b7280, #4b5563);
      }
      
      .btn-danger {
        background: linear-gradient(180deg, var(--danger), #dc2626);
      }
      
      .btn-yandex {
        background: linear-gradient(180deg, var(--yandex), #e62e1c);
      }
      
      /* Status Messages */
      .status {
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 14px;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .status.success {
        background: rgba(34,197,94,0.1);
        border: 1px solid rgba(34,197,94,0.3);
        color: var(--accent);
      }
      
      .status.error {
        background: rgba(239,68,68,0.1);
        border: 1px solid rgba(239,68,68,0.3);
        color: var(--danger);
      }
      
      .status.info {
        background: rgba(59,130,246,0.1);
        border: 1px solid rgba(59,130,246,0.3);
        color: #60a5fa;
      }
      
      /* Toggle Switch */
      .toggle-switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
      }
      
      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      
      .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #4b5563;
        transition: 0.3s;
        border-radius: 24px;
      }
      
      .toggle-slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.3s;
        border-radius: 50%;
      }
      
      input:checked + .toggle-slider {
        background-color: var(--accent);
      }
      
      input:checked + .toggle-slider:before {
        transform: translateX(26px);
      }
      
      /* Connection Status */
      .connection-status {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 13px;
        margin-top: 12px;
      }
      
      .connection-status.connected {
        background: rgba(34,197,94,0.1);
        color: var(--accent);
      }
      
      .connection-status.disconnected {
        background: rgba(239,68,68,0.1);
        color: var(--danger);
      }
      
      .connection-status.unknown {
        background: rgba(148,163,184,0.1);
        color: var(--muted);
      }
      
      /* Divider */
      .divider {
        height: 1px;
        background: rgba(148,163,184,0.2);
        margin: 24px 0;
      }
      
      /* Action Buttons */
      .action-buttons {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }
      
      /* Responsive */
      @media (max-width: 768px) {
        .container {
          padding: 16px;
        }
        
        .settings-section {
          padding: 16px;
        }
        
        .action-buttons {
          flex-direction: column;
        }
        
        .btn {
          width: 100%;
        }
      }
    </style>
    <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f172a">
<link rel="icon" href="icons/icon.svg" type="image/svg+xml">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="MyFitness">
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Настройки</h1>
        <p>Настройка приложения и синхронизации данных</p>
      </div>
      
      <!-- Yandex.Disk Settings -->
      <div class="settings-section">
        <h3>
          <span class="section-icon">☁️</span>
          Яндекс.Диск
        </h3>
        <p style="color: var(--muted); margin-bottom: 20px;">
          Настройте синхронизацию с Яндекс.Диском для доступа к вашим тренировкам с любого устройства
        </p>
        
        <div class="form-group">
          <div id="authStatus">
            <!-- Auth status will be shown here -->
          </div>
          <div class="action-buttons">
            <button class="btn btn-yandex" id="loginBtn">Войти через Яндекс</button>
            <button class="btn btn-secondary" id="logoutBtn" style="display: none;">Выйти</button>
          </div>
          <div class="help-text">
            Войдите через Яндекс для автоматической синхронизации данных
          </div>
        </div>
        
        <div class="form-group">
          <label for="yandexPath">Путь к файлу тренировок</label>
          <input 
            id="yandexPath" 
            type="text" 
            placeholder="/workouts.json"
            value="/workouts.json"
          />
          <div class="help-text">
            Путь к JSON файлу на Яндекс.Диске, где будут храниться ваши тренировки
          </div>
        </div>
        
        <div class="action-buttons">
          <button class="btn btn-secondary" id="syncNow">Синхронизировать сейчас</button>
        </div>
        
        <div id="connectionStatus"></div>
      </div>
      
      <!-- App Settings -->
      <div class="settings-section">
        <h3>
          <span class="section-icon">⚙️</span>
          Настройки приложения
        </h3>
        
        <div class="form-group">
          <label for="autoSync">Автоматическая синхронизация</label>
          <div style="display: flex; align-items: center; gap: 12px; margin-top: 8px;">
            <label class="toggle-switch">
              <input type="checkbox" id="autoSync" checked>
              <span class="toggle-slider"></span>
            </label>
            <span style="font-size: 14px;">Синхронизировать данные автоматически при изменениях</span>
          </div>
        </div>
        
        <div class="form-group">
          <label for="syncInterval">Интервал синхронизации</label>
          <select id="syncInterval">
            <option value="5">5 минут</option>
            <option value="15" selected>15 минут</option>
            <option value="30">30 минут</option>
            <option value="60">1 час</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="defaultCycle">Цикл по умолчанию</label>
          <input 
            id="defaultCycle" 
            type="number" 
            min="1" 
            value="1"
            placeholder="1"
          />
        </div>
        
        <div class="form-group">
          <label for="theme">Тема оформления</label>
          <select id="theme">
            <option value="dark" selected>Темная</option>
            <option value="light">Светлая</option>
            <option value="auto">Авто</option>
          </select>
        </div>
      </div>
      
      <!-- Data Management -->
      <div class="settings-section">
        <h3>
          <span class="section-icon">💾</span>
          Управление данными
        </h3>
        
        <div class="action-buttons">
          <button class="btn btn-secondary" id="exportData">Экспорт данных</button>
          <button class="btn btn-secondary" id="importData">Импорт данных</button>
          <button class="btn btn-danger" id="clearData">Очистить все данные</button>
        </div>
        
        <div class="help-text" style="margin-top: 12px;">
          Экспорт создаст резервную копию всех ваших тренировок в JSON формате
        </div>
      </div>
      
      <!-- About -->
      <div class="settings-section">
        <h3>
          <span class="section-icon">ℹ️</span>
          О приложении
        </h3>
        
        <div style="color: var(--muted);">
          <p><strong>MyFitness</strong> - Дневник тренировок</p>
          <p>Версия: 1.0.0</p>
          <p>Синхронизация с Яндекс.Диском для доступа с любых устройств</p>
        </div>
      </div>
    </div>

    <script>
      // Configuration management
      const CONFIG_KEY = 'myfitness_config';
      
      let config = {
        yandexToken: '',
        yandexPath: '/workouts.json',
        autoSync: true,
        syncInterval: 15,
        defaultCycle: 1,
        theme: 'dark'
      };
      
      function loadConfig() {
        try {
          const saved = localStorage.getItem(CONFIG_KEY);
          if (saved) {
            config = { ...config, ...JSON.parse(saved) };
            applyConfigToUI();
            updateAuthStatus();
          }
        } catch (e) {
          console.warn('Failed to load config:', e);
        }
      }

      function updateAuthStatus() {
        const authStatus = document.getElementById('authStatus');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        
        if (config.yandexToken && config.userInfo) {
          authStatus.innerHTML = `
            <div style="background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.3); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
              <div style="color: var(--accent); font-weight: 600; margin-bottom: 4px;">Вошли как ${config.userInfo.real_name || config.userInfo.display_name || 'Пользователь'}</div>
              <div style="font-size: 12px; color: var(--muted);">${config.userInfo.default_email || ''}</div>
            </div>
          `;
          loginBtn.style.display = 'none';
          logoutBtn.style.display = 'inline-block';
        } else {
          authStatus.innerHTML = `
            <div style="background: rgba(148,163,184,0.1); border: 1px solid rgba(148,163,184,0.3); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
              <div style="color: var(--muted);">Не авторизованы</div>
            </div>
          `;
          loginBtn.style.display = 'inline-block';
          logoutBtn.style.display = 'none';
        }
      }
      
      function saveConfig() {
        try {
          config.yandexPath = document.getElementById('yandexPath').value;
          config.autoSync = document.getElementById('autoSync').checked;
          config.syncInterval = parseInt(document.getElementById('syncInterval').value);
          config.defaultCycle = parseInt(document.getElementById('defaultCycle').value);
          config.theme = document.getElementById('theme').value;
          
          localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
          showStatus('Настройки сохранены', 'success');
        } catch (e) {
          console.warn('Failed to save config:', e);
          showStatus('Ошибка сохранения настроек', 'error');
        }
      }
      
      function applyConfigToUI() {
        document.getElementById('yandexPath').value = config.yandexPath;
        document.getElementById('autoSync').checked = config.autoSync;
        document.getElementById('syncInterval').value = config.syncInterval;
        document.getElementById('defaultCycle').value = config.defaultCycle;
        document.getElementById('theme').value = config.theme;
      }
      
      function showStatus(message, type = 'info') {
        const statusEl = document.getElementById('connectionStatus');
        statusEl.innerHTML = `<div class="status ${type}">${message}</div>`;
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
          statusEl.innerHTML = '';
        }, 5000);
      }
      
      function loginWithYandex() {
        console.log('loginWithYandex called');
        const oauthUrl = `https://oauth.yandex.ru/authorize?response_type=token&client_id=07ca787a8f60406eab80bce2c2cf80c4&redirect_uri=${encodeURIComponent(window.location.origin + window.location.pathname)}`;
        console.log('OAuth URL:', oauthUrl);
        console.log('Redirecting to:', oauthUrl);
        window.location.href = oauthUrl;
      }

      function logoutFromYandex() {
        config.yandexToken = '';
        config.userInfo = null;
        localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
        updateAuthStatus();
        showStatus('Выход выполнен', 'info');
      }
      
      function exportData() {
        try {
          const workouts = JSON.parse(localStorage.getItem('workouts') || '[]');
          const dataStr = JSON.stringify(workouts, null, 2);
          const dataBlob = new Blob([dataStr], { type: 'application/json' });
          
          const link = document.createElement('a');
          link.href = URL.createObjectURL(dataBlob);
          link.download = `myfitness-backup-${new Date().toISOString().split('T')[0]}.json`;
          link.click();
          
          showStatus('Данные экспортированы', 'success');
        } catch (e) {
          showStatus('Ошибка экспорта данных', 'error');
        }
      }
      
      function importData() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        
        input.onchange = (e) => {
          const file = e.target.files[0];
          if (!file) return;
          
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const data = JSON.parse(e.target.result);
              localStorage.setItem('workouts', JSON.stringify(data));
              showStatus('Данные импортированы', 'success');
            } catch (e) {
              showStatus('Ошибка импорта: неверный формат файла', 'error');
            }
          };
          reader.readAsText(file);
        };
        
        input.click();
      }
      
      function clearData() {
        if (confirm('Вы уверены, что хотите удалить все данные? Это действие нельзя отменить.')) {
          localStorage.removeItem('workouts');
          showStatus('Все данные удалены', 'success');
        }
      }
      
      function syncNow() {
        showStatus('Синхронизация запущена...', 'info');
        // TODO: Implement actual sync logic
        setTimeout(() => {
          showStatus('Синхронизация завершена', 'success');
        }, 2000);
      }
      
      // Event listeners
      console.log('Setting up settings page event listeners...');
      const loginBtn = document.getElementById('loginBtn');
      console.log('loginBtn:', loginBtn);
      loginBtn.addEventListener('click', loginWithYandex);
      console.log('Login button event listener added');
      
      document.getElementById('logoutBtn').addEventListener('click', logoutFromYandex);
      document.getElementById('syncNow').addEventListener('click', syncNow);
      document.getElementById('exportData').addEventListener('click', exportData);
      document.getElementById('importData').addEventListener('click', importData);
      document.getElementById('clearData').addEventListener('click', clearData);
      
      // Auto-save on input changes
      [
        'yandexPath', 'autoSync', 'syncInterval', 'defaultCycle', 'theme'
      ].forEach(id => {
        const element = document.getElementById(id);
        if (element.type === 'checkbox') {
          element.addEventListener('change', saveConfig);
        } else {
          element.addEventListener('blur', saveConfig);
        }
      });
      
      // Initialize
      loadConfig();
    </script>
    <script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function () {
    navigator.serviceWorker.register('./service-worker.js')
      .catch(function (e) { console.warn('SW registration failed', e); });
  });
}
</script>
  </body>
</html>
