<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MyFitness - –î–Ω–µ–≤–Ω–∏–∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      :root {
        --bg: #0f172a;
        --card: #111827;
        --text: #e5e7eb;
        --muted: #94a3b8;
        --accent: #22c55e;
        --warn: #f59e0b;
        --danger: #ef4444;
        --yandex: #fc3f1d;
        --sidebar: #1e293b;
        --sidebar-hover: #334155;
        --sidebar-active: #3b82f6;
      }
      * { box-sizing: border-box; }
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        background: var(--bg);
        color: var(--text);
        font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        line-height: 1.6;
      }
      
      .app-container {
        display: flex;
        height: 100vh;
      }
      
      /* Sidebar */
      .sidebar {
        width: 280px;
        background: var(--sidebar);
        border-right: 1px solid rgba(148,163,184,0.2);
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
      }
      
      .sidebar-header {
        padding: 24px 20px 16px;
        border-bottom: 1px solid rgba(148,163,184,0.2);
      }
      
      .sidebar-header h1 {
        margin: 0;
        font-size: 20px;
        font-weight: 600;
        color: var(--text);
      }
      
      .sidebar-header p {
        margin: 4px 0 0;
        font-size: 13px;
        color: var(--muted);
      }
      
      .sidebar-nav {
        flex: 1;
        padding: 16px 0;
      }
      
      .nav-item {
        display: flex;
        align-items: center;
        padding: 12px 20px;
        color: var(--text);
        text-decoration: none;
        transition: all 0.2s ease;
        border-left: 3px solid transparent;
        cursor: pointer;
      }
      
      .nav-item:hover {
        background: var(--sidebar-hover);
        color: var(--text);
      }
      
      .nav-item.active {
        background: var(--sidebar-active);
        color: white;
        border-left-color: var(--accent);
      }
      
      .nav-icon {
        width: 20px;
        height: 20px;
        margin-right: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
      }
      
      .nav-text {
        font-size: 14px;
        font-weight: 500;
      }
      
      /* Main Content */
      .main-content {
        flex: 1;
        overflow-y: auto;
        background: radial-gradient(1200px 800px at 20% 0%, #1f2937 0%, var(--bg) 60%);
      }
      
      .content-header {
        padding: 32px 32px 24px;
        border-bottom: 1px solid rgba(148,163,184,0.2);
      }
      
      .content-header h2 {
        margin: 0 0 8px;
        font-size: 24px;
        font-weight: 600;
      }
      
      .content-header p {
        margin: 0;
        color: var(--muted);
        font-size: 16px;
      }
      
      .content-body {
        padding: 32px;
      }
      
      /* Workout Form */
      .workout-form {
        background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
        border: 1px solid rgba(148, 163, 184, 0.2);
        border-radius: 14px;
        padding: 24px;
        margin-bottom: 24px;
      }
      
      .workout-form h3 {
        margin: 0 0 20px;
        font-size: 18px;
        font-weight: 600;
      }
      
      .wf-controls {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
      }
      
      .wf-controls .ctrl {
        display: grid;
        grid-template-columns: auto 1fr;
        align-items: center;
        gap: 8px;
      }
      
      .wf-controls label {
        font-size: 13px;
        color: var(--muted);
        white-space: nowrap;
      }
      
      .wf-controls input,
      .wf-controls select {
        background: #0b1220;
        color: var(--text);
        border: 1px solid rgba(148,163,184,0.25);
        border-radius: 8px;
        padding: 8px 10px;
        font-size: 14px;
        outline: none;
      }
      
      .wf-grid {
        display: grid;
        grid-template-columns: 1.2fr 1.4fr 2.2fr;
        gap: 10px;
        align-items: center;
      }
      
      .wf-head {
        font-size: 12px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: .04em;
        border-bottom: 1px solid rgba(148,163,184,0.2);
        padding-bottom: 6px;
        margin-top: 6px;
      }
      
      .wf-row {
        display: contents;
      }
      
      .wf-row .label {
        font-size: 14px;
      }
      
      .wf-row select,
      .wf-row input[type="number"] {
        background: #0b1220;
        color: var(--text);
        border: 1px solid rgba(148,163,184,0.25);
        border-radius: 8px;
        padding: 8px 10px;
        font-size: 14px;
        outline: none;
      }
      
      .sets { display: flex; flex-direction: column; gap: 6px; }
      .set-row { display: grid; grid-template-columns: auto max-content max-content 26px; gap: 6px; align-items: center; }
      .set-row .em-label { font-size: 12px; color: var(--muted); }
      .pair { display: inline-grid; grid-template-columns: auto 80px; align-items: center; column-gap: 4px; }
      
      .btn-secondary {
        background: linear-gradient(180deg, #6b7280, #4b5563);
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 6px 10px;
        font-size: 13px;
        cursor: pointer;
      }
      
      .remove-set {
        background: transparent;
        color: #ef4444;
        border: 1px solid rgba(239,68,68,0.5);
        border-radius: 6px;
        width: 26px; height: 26px;
        line-height: 24px; text-align: center;
        cursor: pointer;
      }
      
      .wf-actions {
        display: flex;
        gap: 10px;
        margin-top: 16px;
        flex-wrap: wrap;
      }
      
      #saveWorkoutBtn {
        background: linear-gradient(180deg, #22c55e, #16a34a);
        color: white;
        border: none;
        border-radius: 10px;
        padding: 10px 14px;
        font-size: 16px;
        cursor: pointer;
        transition: transform 0.03s ease;
      }
      
      /* Status */
      .status {
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 13px;
        margin-bottom: 8px;
      }
      
      .status.success {
        background: rgba(34,197,94,0.1);
        border: 1px solid rgba(34,197,94,0.3);
        color: var(--accent);
      }
      
      .status.error {
        background: rgba(239,68,68,0.1);
        border: 1px solid rgba(239,68,68,0.3);
        color: var(--danger);
      }
      
      .status.info {
        background: rgba(59,130,246,0.1);
        border: 1px solid rgba(59,130,246,0.3);
        color: #60a5fa;
      }

      /* Exercise Selection Styles */
      .exercise-selection {
        margin-bottom: 20px;
      }

      .exercise-filters {
        margin-bottom: 16px;
      }

      .search-container {
        margin-bottom: 12px;
      }

      .exercise-search {
        width: 100%;
        background: #0b1220;
        color: var(--text);
        border: 1px solid rgba(148,163,184,0.25);
        border-radius: 8px;
        padding: 10px 12px;
        font-size: 14px;
        outline: none;
      }

      .exercise-search:focus {
        border-color: var(--accent);
      }

      .filter-buttons {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
        flex-wrap: wrap;
      }

      .filter-btn {
        background: rgba(148,163,184,0.1);
        color: var(--text);
        border: 1px solid rgba(148,163,184,0.25);
        border-radius: 6px;
        padding: 6px 12px;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .filter-btn:hover {
        background: rgba(148,163,184,0.2);
      }

      .filter-btn.active {
        background: var(--accent);
        color: white;
        border-color: var(--accent);
      }

      .group-filters {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
      }

      .group-btn {
        background: rgba(59,130,246,0.1);
        color: #60a5fa;
        border: 1px solid rgba(59,130,246,0.3);
        border-radius: 6px;
        padding: 4px 8px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .group-btn:hover {
        background: rgba(59,130,246,0.2);
      }

      .group-btn.active {
        background: #3b82f6;
        color: white;
        border-color: #3b82f6;
      }

      .exercise-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 12px;
        margin-bottom: 16px;
      }

      .exercise-card {
        background: rgba(148,163,184,0.05);
        border: 1px solid rgba(148,163,184,0.15);
        border-radius: 8px;
        padding: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
      }

      .exercise-card:hover {
        background: rgba(148,163,184,0.1);
        border-color: rgba(148,163,184,0.3);
        transform: translateY(-1px);
      }

      .exercise-card.selected {
        background: rgba(34,197,94,0.1);
        border-color: var(--accent);
      }

      .exercise-card.selected::after {
        content: "‚úì";
        position: absolute;
        top: 8px;
        right: 8px;
        background: var(--accent);
        color: white;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
      }

      .exercise-name {
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 4px;
        color: var(--text);
      }

      .exercise-group {
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 6px;
      }

      .exercise-tags {
        display: flex;
        gap: 4px;
        flex-wrap: wrap;
      }

      .exercise-tag {
        background: rgba(148,163,184,0.1);
        color: var(--muted);
        border-radius: 4px;
        padding: 2px 6px;
        font-size: 10px;
      }

      .selected-counter {
        text-align: center;
        font-size: 14px;
        color: var(--muted);
        margin-bottom: 16px;
      }

      .selected-counter span {
        color: var(--accent);
        font-weight: 600;
      }

      .selected-exercises {
        margin-bottom: 16px;
      }

      .selected-exercise-item {
        background: rgba(34,197,94,0.05);
        border: 1px solid rgba(34,197,94,0.2);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 8px;
      }

      .selected-exercise-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }

      .selected-exercise-name {
        font-weight: 600;
        color: var(--text);
      }

      .remove-exercise-btn {
        background: rgba(239,68,68,0.1);
        color: #ef4444;
        border: 1px solid rgba(239,68,68,0.3);
        border-radius: 4px;
        padding: 2px 6px;
        font-size: 12px;
        cursor: pointer;
      }

      .selected-exercise-sets {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      /* Body Analysis Styles */
      .body-analysis-form {
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
      }

      .analysis-description {
        color: var(--muted);
        margin-bottom: 24px;
        text-align: center;
      }

      .photo-upload-section {
        margin-bottom: 24px;
      }

      .upload-area {
        border: 2px dashed rgba(148,163,184,0.3);
        border-radius: 12px;
        padding: 40px 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: rgba(148,163,184,0.02);
      }

      .upload-area:hover {
        border-color: var(--accent);
        background: rgba(34,197,94,0.05);
      }

      .upload-area.dragover {
        border-color: var(--accent);
        background: rgba(34,197,94,0.1);
      }

      .upload-icon {
        font-size: 48px;
        margin-bottom: 12px;
        color: var(--muted);
      }

      .upload-text {
        color: var(--muted);
        font-size: 16px;
      }

      .photo-preview {
        text-align: center;
        margin-top: 16px;
      }

      .photo-preview img {
        max-width: 100%;
        max-height: 300px;
        border-radius: 8px;
        border: 1px solid rgba(148,163,184,0.2);
      }

      .retake-btn {
        margin-top: 12px;
        background: rgba(239,68,68,0.1);
        color: #ef4444;
        border: 1px solid rgba(239,68,68,0.3);
        border-radius: 6px;
        padding: 8px 16px;
        cursor: pointer;
      }

      .analysis-controls {
        display: flex;
        gap: 12px;
        justify-content: center;
        margin-bottom: 24px;
        flex-wrap: wrap;
      }

      .analysis-results {
        background: rgba(34,197,94,0.05);
        border: 1px solid rgba(34,197,94,0.2);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 24px;
      }

      .analysis-results h4 {
        margin-bottom: 16px;
        color: var(--accent);
      }

      .result-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid rgba(148,163,184,0.1);
      }

      .result-item:last-child {
        border-bottom: none;
      }

      .result-label {
        font-weight: 600;
        color: var(--text);
      }

      .result-value {
        color: var(--accent);
        font-weight: 600;
      }

      .analysis-history {
        background: rgba(148,163,184,0.02);
        border: 1px solid rgba(148,163,184,0.1);
        border-radius: 12px;
        padding: 20px;
      }

      .analysis-history h4 {
        margin-bottom: 16px;
        color: var(--text);
      }

      .history-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        background: rgba(255,255,255,0.02);
        border-radius: 8px;
        margin-bottom: 8px;
      }

      .history-date {
        color: var(--muted);
        font-size: 14px;
      }

      .history-fat {
        color: var(--accent);
        font-weight: 600;
      }

      /* Progress Charts Styles */
      .progress-charts {
        background: rgba(148,163,184,0.02);
        border: 1px solid rgba(148,163,184,0.1);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 24px;
      }

      .progress-charts h4 {
        margin-bottom: 16px;
        color: var(--text);
        text-align: center;
      }

      .chart-container {
        background: rgba(255,255,255,0.02);
        border: 1px solid rgba(148,163,184,0.1);
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
        text-align: center;
      }

      .chart-container canvas {
        max-width: 100%;
        height: auto;
      }

      .chart-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 12px;
      }

      .stat-card {
        background: rgba(255,255,255,0.03);
        border: 1px solid rgba(148,163,184,0.1);
        border-radius: 8px;
        padding: 12px;
        text-align: center;
      }

      .stat-title {
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 4px;
      }

      .stat-value {
        font-size: 18px;
        font-weight: 600;
        color: var(--accent);
      }

      /* Responsive chart */
      @media (max-width: 768px) {
        .chart-stats {
          grid-template-columns: 1fr;
        }
        
        .chart-container canvas {
          max-height: 250px;
        }
      }
      
      /* Responsive */
      @media (max-width: 768px) {
        .app-container {
          flex-direction: column;
        }
        
        .sidebar {
          width: 100%;
          height: auto;
        }
        
        .sidebar-nav {
          display: flex;
          overflow-x: auto;
          padding: 12px;
        }
        
        .nav-item {
          flex-shrink: 0;
          padding: 8px 16px;
          border-left: none;
          border-bottom: 3px solid transparent;
        }
        
        .nav-item.active {
          border-left-color: transparent;
          border-bottom-color: var(--accent);
        }
      }
      
      /* Welcome page styles */
      .welcome-card {
        background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
        border: 1px solid rgba(148, 163, 184, 0.2);
        border-radius: 14px;
        padding: 32px;
        text-align: center;
        max-width: 600px;
        margin: 0 auto;
      }
      
      .welcome-icon {
        font-size: 48px;
        margin-bottom: 16px;
        color: var(--accent);
      }
      
      .welcome-title {
        font-size: 28px;
        font-weight: 600;
        margin-bottom: 12px;
      }
      
      .welcome-subtitle {
        font-size: 16px;
        color: var(--muted);
        margin-bottom: 24px;
        line-height: 1.6;
      }
      
      .welcome-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 16px;
        margin-top: 24px;
      }
      
      .stat-item {
        background: rgba(255,255,255,0.03);
        border: 1px solid rgba(148,163,184,0.2);
        border-radius: 10px;
        padding: 16px;
        transition: all 0.2s ease;
      }
      
      .stat-item:hover {
        background: rgba(255,255,255,0.05);
        border-color: var(--accent);
      }
      
      .stat-value {
        font-size: 24px;
        font-weight: 600;
        color: var(--accent);
        margin-bottom: 4px;
      }
      
      .stat-label {
        font-size: 12px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .welcome-features {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 32px;
      }
      
      .feature-item {
        background: rgba(255,255,255,0.02);
        border: 1px solid rgba(148,163,184,0.1);
        border-radius: 10px;
        padding: 20px;
        text-align: left;
      }
      
      .feature-icon {
        font-size: 24px;
        margin-bottom: 12px;
        color: var(--accent);
      }
      
      .feature-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 8px;
      }
      
      .feature-desc {
        font-size: 14px;
        color: var(--muted);
        line-height: 1.5;
      }
      
      /* Button styles */
      .btn-primary {
        background: linear-gradient(135deg, var(--accent), #16a34a);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 12px 24px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        display: inline-block;
      }
      
      .btn-primary:hover {
        background: linear-gradient(135deg, #16a34a, var(--accent));
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
      }
      
      .btn-primary:active {
        transform: translateY(0);
      }
     /* Workout set row: responsive layout fix */
.sets { display: grid; gap: 8px; }

.set-row {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr auto; /* label, reps, weight, remove */
  gap: 8px;
  align-items: center;
  padding: 10px;
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(148,163,184,0.2);
  border-radius: 8px;
}

.set-row .em-label {
  white-space: nowrap;
  font-size: 12px;
  color: var(--muted);
}

.set-row .pair {
  display: flex;
  align-items: center;
  gap: 8px;
  min-width: 0;
}

.set-row .pair input {
  flex: 1 1 auto;
  width: 100%;
  min-width: 0;
}

.set-row .remove-set {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
  border-radius: 6px;
  border: 1px solid rgba(239,68,68,0.4);
  background: rgba(239,68,68,0.08);
  color: var(--danger);
  cursor: pointer;
}

/* Mobile: stack fields, keep remove button in top-right inside row */
@media (max-width: 480px) {
  .set-row {
    grid-template-columns: 1fr auto; /* text + remove */
    grid-auto-rows: auto;
  }
  .set-row .em-label { grid-column: 1 / 2; }
  .set-row .pair { grid-column: 1 / -1; } /* reps and weight take full width */
  .set-row .remove-set {
    grid-column: 2 / 3;
    align-self: start;
  }
} 
      /* Workout set row: mobile fix */
.sets { display: grid; gap: 10px; }

.set-row {
  position: relative;                 /* —á—Ç–æ–±—ã –∫—Ä–µ—Å—Ç–∏–∫ –∂–∏–ª –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞ */
  display: grid;
  grid-template-columns: auto 1fr 1fr 36px;  /* –º–µ—Ç–∫–∞, –ü–æ–≤—Ç., –í–µ—Å, –∫—Ä–µ—Å—Ç–∏–∫ */
  gap: 8px;
  align-items: center;
  padding: 10px 12px;
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(148,163,184,0.2);
  border-radius: 8px;
}

.set-row .pair {
  display: flex;
  align-items: center;
  gap: 8px;
  min-width: 0;
}

.set-row input,
.set-row select {
  width: 100%;
  min-width: 0;
}

.set-row .remove-set {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 28px;
  height: 28px;
  border-radius: 6px;
  border: 1px solid rgba(239,68,68,0.4);
  background: rgba(239,68,68,0.08);
  color: var(--danger);
  cursor: pointer;
}

/* –£–∑–∫–∏–µ —ç–∫—Ä–∞–Ω—ã: —Å–∫–ª–∞–¥—ã–≤–∞–µ–º –≤ —Å—Ç–æ–ª–±–µ—Ü, –∫—Ä–µ—Å—Ç–∏–∫ ‚Äî –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞ */
@media (max-width: 480px) {
  .set-row {
    grid-template-columns: 1fr;
    padding-right: 48px;              /* –º–µ—Å—Ç–æ –ø–æ–¥ –∫—Ä–µ—Å—Ç–∏–∫ –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞ */
  }
  .set-row .pair { grid-column: 1 / -1; }
  .set-row .remove-set {
    position: absolute;
    top: 8px;
    right: 8px;                       /* –±–æ–ª—å—à–µ –Ω–µ –≤—ã–ª–µ–∑–∞–µ—Ç –∑–∞ –ø—Ä–µ–¥–µ–ª—ã */
  }
}
      /* Multi-exercise UI */
.group-exercises { display: grid; gap: 12px; }
.exercise-block {
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(148,163,184,0.2);
  border-radius: 10px;
  padding: 12px;
}
.exercise-header {
  display: grid; align-items: center; gap: 8px; margin-bottom: 10px;
  grid-template-columns: max-content auto auto; /* select | add | remove */
}
.exercise-select { width: 240px; min-width: 0; }
.remove-exercise {
  width: 32px; height: 32px; border-radius: 6px;
  border: 1px solid rgba(239,68,68,0.4);
  background: rgba(239,68,68,0.08); color: var(--danger); cursor: pointer;
}
.wf-row .group-exercises { grid-column: 2 / 4; }
.wf-row .group-actions { grid-column: 3 / 4; display: flex; justify-content: flex-end; }
      /* Mobile fixes for multi-exercise layout */
.exercise-block { position: relative; }
.exercise-header {
  display: grid;
  grid-template-columns: max-content auto auto;  /* select | add | remove */
  gap: 8px;
  align-items: center;
}
.exercise-select { width: 240px; min-width: 0; }
.remove-exercise {
  position: static;                  /* —á—Ç–æ–±—ã –Ω–µ "–≤—ã–ø–æ–ª–∑–∞–ª" –∑–∞ –ø—Ä–µ–¥–µ–ª—ã */
  width: 28px; height: 28px;
  border-radius: 6px;
  border: 1px solid rgba(239,68,68,0.4);
  background: rgba(239,68,68,0.08);
  color: var(--danger);
}

/* –ì—Ä–∏–¥ —Å—Ç—Ä–æ–∫–∏ –≥—Ä—É–ø–ø—ã –Ω–∞ —É–∑–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö ‚Äî –≤ –æ–¥–Ω—É –∫–æ–ª–æ–Ω–∫—É */
@media (max-width: 600px) {
  .wf-grid { grid-template-columns: 1fr !important; gap: 12px; }
  .wf-row { overflow: hidden; }
  .wf-row .label { grid-column: 1 / -1; }
  .wf-row select { grid-column: 1 / -1; }
  .wf-row .group-exercises { grid-column: 1 / -1; }
  .wf-row .group-actions { grid-column: 1 / -1; justify-content: stretch; }
  .group-actions .btn-secondary { width: 100%; }
}
/* Compact controls */
.icon-btn{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:6px;border:1px solid rgba(148,163,184,.25);background:#0b1220;color:#e5e7eb}
.icon-btn:hover{background:rgba(255,255,255,.06)}
.add-set-icon{border-color:rgba(34,197,94,.35);color:#22c55e;background:rgba(34,197,94,.08)}
.remove-exercise{width:28px;height:28px}

/* Hide big text buttons -> make them icon-only */
.exercise-block .add-set-btn{font-size:0;padding:0;width:28px;height:28px;border-radius:6px}
.exercise-block .add-set-btn::before{content:'+';font-size:18px;line-height:1;color:#22c55e}
.group-actions .btn-secondary{font-size:0;padding:0 0;width:32px;height:32px;border-radius:6px}
.group-actions .btn-secondary::before{content:'+';font-size:18px;color:#e5e7eb}
.group-actions{display:flex;justify-content:flex-end}

/* Tighter mobile spacing */
@media (max-width:600px){
  .exercise-header{gap:6px}
  .exercise-block{padding:10px}
}
    </style>
    <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f172a">
<link rel="icon" href="icons/icon.svg" type="image/svg+xml">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="MyFitness">
  </head>
  <body>
    <div class="app-container">
      <!-- Sidebar Navigation -->
      <div class="sidebar">
        <div class="sidebar-header">
          <h1>MyFitness</h1>
          <p>–î–Ω–µ–≤–Ω–∏–∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</p>
        </div>
        
        <nav class="sidebar-nav">
          <div class="nav-item active" data-page="welcome">
            <div class="nav-icon">üè†</div>
            <div class="nav-text">–ì–ª–∞–≤–Ω–∞—è</div>
          </div>
          <div class="nav-item" data-page="main">
            <div class="nav-icon">üèãÔ∏è</div>
            <div class="nav-text">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</div>
          </div>
          <div class="nav-item" data-page="history">
            <div class="nav-icon">üìä</div>
            <div class="nav-text">–ò—Å—Ç–æ—Ä–∏—è</div>
          </div>
          <div class="nav-item" data-page="body-analysis">
            <div class="nav-icon">üì∏</div>
            <div class="nav-text">–ê–Ω–∞–ª–∏–∑ —Ç–µ–ª–∞</div>
          </div>
          <div class="nav-item" data-page="settings">
            <div class="nav-icon">‚öôÔ∏è</div>
            <div class="nav-text">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
          </div>
        </nav>
      </div>
      
      <!-- Main Content Area -->
      <div class="main-content">
        <!-- Welcome Page Content -->
        <div id="welcome-page" class="page-content">
          
          <div class="content-body">
            <div class="welcome-card">
              <div class="welcome-icon">üí™</div>
              <h3 class="welcome-title">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ MyFitness!</h3>
              <p class="welcome-subtitle">
                –í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫, –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ñ–∏—Ç–Ω–µ—Å-—Ü–µ–ª–µ–π.
              </p>
              
              <div class="welcome-stats">
                <div class="stat-item">
                  <div class="stat-value" id="totalWorkouts">0</div>
                  <div class="stat-label">–í—Å–µ–≥–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>
                </div>
                <div class="stat-item">
                  <div class="stat-value" id="thisWeek">0</div>
                  <div class="stat-label">–ù–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ</div>
                </div>
                <div class="stat-item">
                  <div class="stat-value" id="thisMonth">0</div>
                  <div class="stat-label">–í —ç—Ç–æ–º –º–µ—Å—è—Ü–µ</div>
                </div>
                <div class="stat-item">
                  <div class="stat-value" id="thisYear">0</div>
                  <div class="stat-label">–í —ç—Ç–æ–º –≥–æ–¥—É</div>
                </div>
              </div>
              
              <div class="welcome-features">
                <div class="feature-item">
                  <div class="feature-icon">üìù</div>
                  <div class="feature-title">–í–µ–¥–µ–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>
                  <div class="feature-desc">–ó–∞–ø–∏—Å—ã–≤–∞–π—Ç–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –ø–æ —Ü–∏–∫–ª–∞–º, –Ω–µ–¥–µ–ª—è–º –∏ —Å–µ—Å—Å–∏—è–º —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º–∏ –ø–æ–¥—Ö–æ–¥–∞–º–∏</div>
                </div>
                <div class="feature-item">
                  <div class="feature-icon">üìä</div>
                  <div class="feature-title">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</div>
                  <div class="feature-desc">–û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É, –≥—Ä–∞—Ñ–∏–∫–∏ –∏ –∏—Å—Ç–æ—Ä–∏—é –≤—Å–µ—Ö –≤–∞—à–∏—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>
                </div>

              </div>
              
              <div style="margin-top: 32px; text-align: center;">
                <button class="btn-primary" onclick="showPage('main')" style="padding: 12px 24px; font-size: 16px;">
                  üèãÔ∏è –ù–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É
                </button>
                              <div style="margin-top: 16px;">
                <button onclick="clearCacheAndReload()" style="padding: 8px 16px; background: var(--muted); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                  üîÑ –û–±–Ω–æ–≤–∏—Ç—å –∫—ç—à
                </button>
                <button onclick="testHuggingFaceToken()" style="margin-left: 8px; padding: 8px 16px; background: var(--accent); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                  üß™ –¢–µ—Å—Ç —Ç–æ–∫–µ–Ω–∞
                </button>
              </div>
              </div>
              
              <!-- Test data section (only visible in development) -->
              <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid rgba(148,163,184,0.2);">
                <details style="text-align: left;">
                  <summary style="cursor: pointer; color: var(--muted); font-size: 14px;">
                    üß™ –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
                  </summary>
                  <div style="margin-top: 12px; display: flex; gap: 8px; justify-content: center;">
                    <button onclick="loadTestData()" style="padding: 8px 16px; background: var(--warn); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                      –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
                    </button>
                    <button onclick="clearTestData()" style="padding: 8px 16px; background: var(--danger); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                      –û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                    </button>
                  </div>
                </details>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Main Page Content -->
        <div id="main-page" class="page-content" style="display: none;">
          
          <div class="content-body">
            <div class="workout-form">
              <h3>–î–Ω–µ–≤–Ω–∏–∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ (FullBody, 3 —Ä–∞–∑–∞/–Ω–µ–¥.)</h3>
              
              <div class="wf-controls">
                <div class="ctrl">
                  <label for="cycle">–¶–∏–∫–ª:</label>
                  <input id="cycle" type="number" min="1" step="1" placeholder="1" />
                </div>
                <div class="ctrl">
                  <label for="week">–ù–µ–¥–µ–ª—è (1‚Äì4):</label>
                  <select id="week">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                  </select>
                </div>
                <div class="ctrl">
                  <label for="session">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ (1‚Äì3):</label>
                  <select id="session">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                  </select>
                </div>
              </div>

              <!-- Exercise Selection Interface -->
              <div class="exercise-selection">
                <!-- Search and Filters -->
                <div class="exercise-filters">
                  <div class="search-container">
                    <input type="text" id="exerciseSearch" placeholder="üîç –ü–æ–∏—Å–∫ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π..." class="exercise-search">
                  </div>
                  
                  <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all">–í—Å–µ</button>
                    <button class="filter-btn" data-filter="popular">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ</button>
                    <button class="filter-btn" data-filter="recent">–ù–µ–¥–∞–≤–Ω–∏–µ</button>
                  </div>
                  
                  <div class="group-filters">
                    <button class="group-btn" data-group="–ì—Ä—É–¥—å">–ì—Ä—É–¥—å</button>
                    <button class="group-btn" data-group="–°–ø–∏–Ω–∞">–°–ø–∏–Ω–∞</button>
                    <button class="group-btn" data-group="–ù–æ–≥–∏">–ù–æ–≥–∏</button>
                    <button class="group-btn" data-group="–ü–ª–µ—á–∏">–ü–ª–µ—á–∏</button>
                    <button class="group-btn" data-group="–ë–∏—Ü–µ–ø—Å">–ë–∏—Ü–µ–ø—Å</button>
                    <button class="group-btn" data-group="–¢—Ä–∏—Ü–µ–ø—Å">–¢—Ä–∏—Ü–µ–ø—Å</button>
                    <button class="group-btn" data-group="–ó–∞–¥–Ω–∏–µ –¥–µ–ª—å—Ç—ã">–ó–∞–¥–Ω–∏–µ –¥–µ–ª—å—Ç—ã</button>
                  </div>
                </div>

                <!-- Exercise Grid -->
                <div class="exercise-grid" id="exerciseGrid">
                  <!-- Exercises will be populated by JavaScript -->
                </div>

                <!-- Selected Exercises Counter -->
                <div class="selected-counter">
                  <span id="selectedCount">0</span> –∏–∑ 8 —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –≤—ã–±—Ä–∞–Ω–æ
                </div>
              </div>

              <!-- Selected Exercises List -->
              <div class="selected-exercises" id="selectedExercises">
                <!-- Selected exercises will be shown here -->
              </div>

              <button id="addSetsToAll" type="button" class="btn-secondary">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ö–æ–¥ –≤–æ –≤—Å–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</button>
              
              <div class="wf-actions">
                <button id="saveWorkoutBtn" type="button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</button>
                <button id="syncBtn" type="button" class="btn-secondary">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- History Page Content -->
        <div id="history-page" class="page-content" style="display: none;">
          
          <div class="content-body">
            <div id="history-content">
              <!-- History content will be loaded here -->
            </div>
          </div>
        </div>
        
        <!-- Body Analysis Page Content -->
        <div id="body-analysis-page" class="page-content" style="display: none;">
          
          <div class="content-body">
            <div class="body-analysis-form">
              <h3>–ê–Ω–∞–ª–∏–∑ —Å–æ—Å—Ç–∞–≤–∞ —Ç–µ–ª–∞</h3>
              <p class="analysis-description">
                –°–¥–µ–ª–∞–π—Ç–µ —Ñ–æ—Ç–æ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –ø—Ä–æ—Ü–µ–Ω—Ç–∞ –∂–∏—Ä–∞ –≤ –æ—Ä–≥–∞–Ω–∏–∑–º–µ. 
                –î–ª—è –ª—É—á—à–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ö–æ—Ä–æ—à–µ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ –∏ —Ñ–æ—Ç–æ –≤ –ø–æ–ª–Ω—ã–π —Ä–æ—Å—Ç.
              </p>
              
              <!-- Photo Upload Section -->
              <div class="photo-upload-section">
                <div class="upload-area" id="uploadArea">
                  <div class="upload-icon">üì∏</div>
                  <div class="upload-text">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–æ—Ç–æ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª</div>
                  <input type="file" id="photoInput" accept="image/*" capture="environment" style="display: none;">
                </div>
                
                <div class="photo-preview" id="photoPreview" style="display: none;">
                  <img id="previewImage" src="" alt="Preview">
                  <button class="retake-btn" onclick="retakePhoto()">–ü–µ—Ä–µ—Å–Ω—è—Ç—å</button>
                </div>
              </div>
              
              <!-- Analysis Controls -->
              <div class="analysis-controls">
                <button id="analyzeBtn" class="btn-primary" onclick="analyzeBody()" disabled>
                  üîç –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ç–æ
                </button>
                <button id="saveBtn" class="btn-secondary" onclick="saveAnalysis()" disabled>
                  üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                </button>
              </div>
              
              <!-- Analysis Results -->
              <div class="analysis-results" id="analysisResults" style="display: none;">
                <h4>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞</h4>
                <div class="result-item">
                  <span class="result-label">–ü—Ä–æ—Ü–µ–Ω—Ç –∂–∏—Ä–∞:</span>
                  <span class="result-value" id="fatPercentage">-</span>
                </div>
                <div class="result-item">
                  <span class="result-label">–£—Ä–æ–≤–µ–Ω—å:</span>
                  <span class="result-value" id="fatLevel">-</span>
                </div>
                <div class="result-item">
                  <span class="result-label">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</span>
                  <span class="result-value" id="recommendations">-</span>
                </div>
                <div class="result-item">
                  <span class="result-label">–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å AI:</span>
                  <span class="result-value" id="confidence">-</span>
                </div>
                <div class="result-item">
                  <span class="result-label">–ú–æ–¥–µ–ª—å:</span>
                  <span class="result-value" id="aiModel">-</span>
                </div>
              </div>
              
              <!-- Progress Charts -->
              <div class="progress-charts">
                <h4>–ì—Ä–∞—Ñ–∏–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</h4>
                <div class="chart-container">
                  <canvas id="fatProgressChart" width="400" height="200"></canvas>
                </div>
                <div class="chart-stats">
                  <div class="stat-card">
                    <div class="stat-title">–°—Ä–µ–¥–Ω–∏–π % –∂–∏—Ä–∞</div>
                    <div class="stat-value" id="avgFatPercentage">-</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-title">–ò–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞ –º–µ—Å—è—Ü</div>
                    <div class="stat-value" id="monthlyChange">-</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-title">–í—Å–µ–≥–æ –∏–∑–º–µ—Ä–µ–Ω–∏–π</div>
                    <div class="stat-value" id="totalMeasurements">-</div>
                  </div>
                </div>
              </div>
              
              <!-- Analysis History -->
              <div class="analysis-history">
                <h4>–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ—Ä–µ–Ω–∏–π</h4>
                <div id="analysisHistory">
                  <!-- History will be loaded here -->
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Settings Page Content -->
        <div id="settings-page" class="page-content" style="display: none;">
          
          <div class="content-body">
            <div id="settings-content">
              <!-- Settings content will be loaded here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Exercise data structure with tags
      const exercises = [
        {
          id: 'bench-press',
          name: '–ñ–∏–º –ª–µ–∂–∞',
          group: '–ì—Ä—É–¥—å',
          tags: ['–±–∞–∑–æ–≤–æ–µ', '—Å–∏–ª–∞', '–∂–∏–º', '—à—Ç–∞–Ω–≥–∞'],
          isPopular: true
        },
        {
          id: 'dips',
          name: '–û—Ç–∂–∏–º–∞–Ω–∏—è –Ω–∞ –±—Ä—É—Å—å—è—Ö',
          group: '–ì—Ä—É–¥—å',
          tags: ['–±–∞–∑–æ–≤–æ–µ', '—Å–∏–ª–∞', '—Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–µ—Å'],
          isPopular: true
        },
        {
          id: 'incline-dumbbell-press',
          name: '–ñ–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π –Ω–∞ —Å–∫–∞–º—å–µ 30 –≥—Ä–∞–¥—É—Å–æ–≤',
          group: '–ì—Ä—É–¥—å',
          tags: ['–∏–∑–æ–ª–∏—Ä—É—é—â–µ–µ', '—Å–∏–ª–∞', '–≥–∞–Ω—Ç–µ–ª–∏', '–Ω–∞–∫–ª–æ–Ω']
        },
        {
          id: 'butterfly-machine',
          name: '–°–≤–µ–¥–µ–Ω–∏–µ —Ä—É–∫ –≤ —Ç—Ä–µ–Ω–∞–∂–µ—Ä–µ –±–∞–±–æ—á–∫–∞',
          group: '–ì—Ä—É–¥—å',
          tags: ['–∏–∑–æ–ª–∏—Ä—É—é—â–µ–µ', '—Å–∏–ª–∞', '—Ç—Ä–µ–Ω–∞–∂–µ—Ä']
        },
        {
          id: 'push-ups',
          name: '–û—Ç–∂–∏–º–∞–Ω–∏—è –æ—Ç –ø–æ–ª–∞',
          group: '–ì—Ä—É–¥—å',
          tags: ['–±–∞–∑–æ–≤–æ–µ', '—Å–∏–ª–∞', '—Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–µ—Å'],
          isPopular: true
        },
        {
          id: 'pull-ups',
          name: '–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏–µ',
          group: '–°–ø–∏–Ω–∞',
          tags: ['–±–∞–∑–æ–≤–æ–µ', '—Å–∏–ª–∞', '—Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–µ—Å'],
          isPopular: true
        },
        {
          id: 'barbell-row',
          name: '–¢—è–≥–∞ —à—Ç–∞–Ω–≥–∏ –∫ –ø–æ—è—Å—É',
          group: '–°–ø–∏–Ω–∞',
          tags: ['–±–∞–∑–æ–≤–æ–µ', '—Å–∏–ª–∞', '—à—Ç–∞–Ω–≥–∞'],
          isPopular: true
        },
        {
          id: 'cable-row',
          name: '–¢—è–≥–∞ –≤ –±–ª–æ—á–Ω–æ–º —Ç—Ä–µ–Ω–∞–∂–µ—Ä–µ',
          group: '–°–ø–∏–Ω–∞',
          tags: ['–∏–∑–æ–ª–∏—Ä—É—é—â–µ–µ', '—Å–∏–ª–∞', '—Ç—Ä–µ–Ω–∞–∂–µ—Ä']
        },
        {
          id: 'single-arm-dumbbell-row',
          name: '–¢—è–≥–∞ –≥–∞–Ω—Ç–µ–ª–∏ –æ–¥–Ω–æ–π —Ä—É–∫–æ–π',
          group: '–°–ø–∏–Ω–∞',
          tags: ['–±–∞–∑–æ–≤–æ–µ', '—Å–∏–ª–∞', '–≥–∞–Ω—Ç–µ–ª–∏'],
          isPopular: true
        },
        {
          id: 'bent-over-barbell-row',
          name: '–¢—è–≥–∞ —à—Ç–∞–Ω–≥–∏ –≤ –Ω–∞–∫–ª–æ–Ω–µ',
          group: '–°–ø–∏–Ω–∞',
          tags: ['–±–∞–∑–æ–≤–æ–µ', '—Å–∏–ª–∞', '—à—Ç–∞–Ω–≥–∞'],
          isPopular: true
        },
        {
          id: 'squat',
          name: '–ü—Ä–∏—Å–µ–¥ —Å–æ —à—Ç–∞–Ω–≥–æ–π',
          group: '–ù–æ–≥–∏',
          tags: ['–±–∞–∑–æ–≤–æ–µ', '—Å–∏–ª–∞', '—à—Ç–∞–Ω–≥–∞'],
          isPopular: true
        },
        {
          id: 'lunges',
          name: '–í—ã–ø–∞–¥—ã —Å –≥–∞–Ω—Ç–µ–ª—è–º–∏',
          group: '–ù–æ–≥–∏',
          tags: ['–±–∞–∑–æ–≤–æ–µ', '—Å–∏–ª–∞', '–≥–∞–Ω—Ç–µ–ª–∏', '–±–∞–ª–∞–Ω—Å']
        },
        {
          id: 'leg-press',
          name: '–ñ–∏–º –Ω–æ–≥–∞–º–∏ –≤ –±–ª–æ—á–Ω–æ–º —Ç—Ä–µ–Ω–∞–∂–µ—Ä–µ',
          group: '–ù–æ–≥–∏',
          tags: ['–∏–∑–æ–ª–∏—Ä—É—é—â–µ–µ', '—Å–∏–ª–∞', '—Ç—Ä–µ–Ω–∞–∂–µ—Ä']
        },
        {
          id: 'romanian-deadlift',
          name: '–†—É–º—ã–Ω—Å–∫–∞—è —Ç—è–≥–∞',
          group: '–ù–æ–≥–∏',
          tags: ['–±–∞–∑–æ–≤–æ–µ', '—Å–∏–ª–∞', '—à—Ç–∞–Ω–≥–∞', '–∑–∞–¥–Ω—è—è –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å –±–µ–¥—Ä–∞'],
          isPopular: true
        },
        {
          id: 'deadlift',
          name: '–°—Ç–∞–Ω–æ–≤–∞—è —Ç—è–≥–∞',
          group: '–ù–æ–≥–∏',
          tags: ['–±–∞–∑–æ–≤–æ–µ', '—Å–∏–ª–∞', '—à—Ç–∞–Ω–≥–∞'],
          isPopular: true
        },
        {
          id: 'bulgarian-split-squat',
          name: '–ë–æ–ª–≥–∞—Ä—Å–∫–∏–µ —Å–ø–ª–∏—Ç-–ø—Ä–∏—Å–µ–¥–∞–Ω–∏—è',
          group: '–ù–æ–≥–∏',
          tags: ['–±–∞–∑–æ–≤–æ–µ', '—Å–∏–ª–∞', '–≥–∞–Ω—Ç–µ–ª–∏', '–±–∞–ª–∞–Ω—Å']
        },
        {
          id: 'lateral-raise',
          name: '–†–∞–∑–≤–µ–¥–µ–Ω–∏–µ —Ä—É–∫ –≤ —Å—Ç–æ—Ä–æ–Ω—ã —Å—Ç–æ—è(–≥–∞–Ω—Ç–µ–ª–∏)',
          group: '–ü–ª–µ—á–∏',
          tags: ['–∏–∑–æ–ª–∏—Ä—É—é—â–µ–µ', '—Å–∏–ª–∞', '–≥–∞–Ω—Ç–µ–ª–∏'],
          isPopular: true
        },
        {
          id: 'upright-row',
          name: '–¢—è–≥–∞ —à—Ç–∞–Ω–≥–∏ —Å w-–æ–±—Ä–∞–∑–Ω—ã–º –≥—Ä–∏—Ñ–æ–º –∫ –ø–æ–¥–±–æ—Ä–æ–¥–∫—É',
          group: '–ü–ª–µ—á–∏',
          tags: ['–∏–∑–æ–ª–∏—Ä—É—é—â–µ–µ', '—Å–∏–ª–∞', '—à—Ç–∞–Ω–≥–∞']
        },
        {
          id: 'overhead-press',
          name: '–ñ–∏–º –Ω–∞–¥ –≥–æ–ª–æ–≤–æ–π(–≥–∞–Ω—Ç–µ–ª–∏)',
          group: '–ü–ª–µ—á–∏',
          tags: ['–±–∞–∑–æ–≤–æ–µ', '—Å–∏–ª–∞', '–≥–∞–Ω—Ç–µ–ª–∏', '–∂–∏–º'],
          isPopular: true
        },
        {
          id: 'hammer-curl',
          name: '–•–∞–º–º–µ—Ä —Å –≥–∞–Ω—Ç–µ–ª—è–º–∏',
          group: '–ë–∏—Ü–µ–ø—Å',
          tags: ['–∏–∑–æ–ª–∏—Ä—É—é—â–µ–µ', '—Å–∏–ª–∞', '–≥–∞–Ω—Ç–µ–ª–∏'],
          isPopular: true
        },
        {
          id: 'ez-bar-curl',
          name: '–ü–æ–¥–Ω—è—Ç–∏–µ —à—Ç–∞–Ω–≥–∏ —Å w-–æ–±—Ä–∞–∑–Ω—ã–º –≥—Ä–∏—Ñ–æ–º',
          group: '–ë–∏—Ü–µ–ø—Å',
          tags: ['–∏–∑–æ–ª–∏—Ä—É—é—â–µ–µ', '—Å–∏–ª–∞', '—à—Ç–∞–Ω–≥–∞']
        },
        {
          id: 'concentration-curl',
          name: '–ü–æ–¥–Ω—è—Ç–∏–µ –≥–∞–Ω—Ç–µ–ª–∏ —Å–∏–¥—è —Å —É–ø–æ—Ä–æ–º –≤ —Ç—Ä–∏—Ü–µ–ø—Å',
          group: '–ë–∏—Ü–µ–ø—Å',
          tags: ['–∏–∑–æ–ª–∏—Ä—É—é—â–µ–µ', '—Å–∏–ª–∞', '–≥–∞–Ω—Ç–µ–ª–∏', '–∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è']
        },
        {
          id: 'overhead-extension',
          name: '–û–ø—É—Å–∫–∞–Ω–∏–µ –≥–∞–Ω—Ç–µ–ª–∏ –∑–∞ –≥–æ–ª–æ–≤—É',
          group: '–¢—Ä–∏—Ü–µ–ø—Å',
          tags: ['–∏–∑–æ–ª–∏—Ä—É—é—â–µ–µ', '—Å–∏–ª–∞', '–≥–∞–Ω—Ç–µ–ª–∏'],
          isPopular: true
        },
        {
          id: 'french-press',
          name: '–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π –∂–∏–º –≥–∞–Ω—Ç–µ–ª—è–º–∏',
          group: '–¢—Ä–∏—Ü–µ–ø—Å',
          tags: ['–∏–∑–æ–ª–∏—Ä—É—é—â–µ–µ', '—Å–∏–ª–∞', '–≥–∞–Ω—Ç–µ–ª–∏']
        },
        {
          id: 'cable-triceps',
          name: '–†–∞–∑–≥–∏–±–∞–Ω–∏—è –Ω–∞ –±–ª–æ–∫–µ',
          group: '–¢—Ä–∏—Ü–µ–ø—Å',
          tags: ['–∏–∑–æ–ª–∏—Ä—É—é—â–µ–µ', '—Å–∏–ª–∞', '—Ç—Ä–µ–Ω–∞–∂–µ—Ä']
        },
        {
          id: 'bench-dips',
          name: '–û—Ç–∂–∏–º–∞–Ω–∏—è –æ—Ç —Å–∫–∞–º—å–∏',
          group: '–¢—Ä–∏—Ü–µ–ø—Å',
          tags: ['–±–∞–∑–æ–≤–æ–µ', '—Å–∏–ª–∞', '—Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–µ—Å'],
          isPopular: true
        },
        {
          id: 'rear-delt-fly',
          name: '–†–∞–∑–≤–æ–¥–∫–∞ —Ä—É–∫ –≤ —Ç—Ä–µ–Ω–∞–∂–µ—Ä–µ-–±–∞–±–æ—á–∫–µ',
          group: '–ó–∞–¥–Ω–∏–µ –¥–µ–ª—å—Ç—ã',
          tags: ['–∏–∑–æ–ª–∏—Ä—É—é—â–µ–µ', '—Å–∏–ª–∞', '—Ç—Ä–µ–Ω–∞–∂–µ—Ä']
        }
      ];

      // Exercise selection state
      let selectedExercises = [];
      let currentFilter = 'all';
      let currentGroupFilter = null;
      let searchQuery = '';

      // Navigation functionality
      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => {
          const page = item.getAttribute('data-page');
          showPage(page);
          
          // Update active state
          document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
          item.classList.add('active');
        });
      });
      
      function showPage(pageName) {
  document.querySelectorAll('.page-content').forEach(p => p.style.display = 'none');

  const targetPage = document.getElementById(pageName + '-page');
  if (targetPage) targetPage.style.display = 'block';

  document.querySelectorAll('.nav-item').forEach(nav => {
    nav.classList.toggle('active', nav.getAttribute('data-page') === pageName);
  });

  if (pageName === 'welcome') loadWelcomePage();
  else if (pageName === 'main') loadMainPage();
  else if (pageName === 'history') loadHistoryPage();
  else if (pageName === 'body-analysis') loadBodyAnalysisPage();
  else if (pageName === 'settings') loadSettingsPage();


}      
      async function loadWelcomePage() {
        // Load statistics from localStorage
        try {
          const workouts = JSON.parse(localStorage.getItem('workouts') || '[]');
          const now = new Date();
          const currentWeek = getWeekNumber(now);
          const currentMonth = now.getMonth();
          const currentYear = now.getFullYear();
          
          let totalWorkouts = workouts.length;
          let thisWeekCount = 0;
          let thisMonthCount = 0;
          let thisYearCount = 0;
          
          workouts.forEach(workout => {
            const workoutDate = new Date(workout.date);
            const workoutWeek = getWeekNumber(workoutDate);
            const workoutMonth = workoutDate.getMonth();
            const workoutYear = workoutDate.getFullYear();
            
            if (workoutYear === currentYear) {
              thisYearCount++;
              if (workoutMonth === currentMonth) {
                thisMonthCount++;
                if (workoutWeek === currentWeek) {
                  thisWeekCount++;
                }
              }
            }
          });
          
          // Update statistics
          document.getElementById('totalWorkouts').textContent = totalWorkouts;
          document.getElementById('thisWeek').textContent = thisWeekCount;
          document.getElementById('thisMonth').textContent = thisMonthCount;
          document.getElementById('thisYear').textContent = thisYearCount;
          
        } catch (e) {
          console.warn('Failed to load welcome page statistics:', e);
        }
      }
      
      function getWeekNumber(date) {
        const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
        const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
        return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
      }
      
      async function loadHistoryPage() {
        const historyContent = document.getElementById('history-content');
        historyContent.innerHTML = `
          <div style="text-align: center; padding: 40px;">
            <h3>–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</h3>
            <p>–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∑–¥–µ—Å—å</p>
          </div>
        `;
        
        try {
          const response = await fetch(`./history.html?v=${Date.now()}&cache=${Math.random()}&force=${Date.now()}`);
          const html = await response.text();
          
          // Extract body content
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          const bodyContent = doc.body.querySelector('.container');
          
          if (bodyContent) {
            historyContent.innerHTML = bodyContent.innerHTML;
            
            // Add custom CSS to override stats layout and new compact workout format
            const style = document.createElement('style');
            style.textContent = `
              .stats-grid {
                display: grid !important;
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 16px !important;
                margin-bottom: 24px !important;
              }
              .stats-grid:nth-child(2) {
                margin-top: 16px !important;
              }
              
              /* Compact workout format */
              .compact-workout-item {
                background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
                border: 1px solid rgba(148, 163, 184, 0.2);
                border-radius: 12px;
                padding: 20px;
                margin-bottom: 16px;
              }
              
              .workout-date {
                font-size: 18px;
                font-weight: 700;
                color: var(--accent);
                margin-bottom: 12px;
                text-align: center;
              }
              
              .workout-exercises {
                font-size: 14px;
                line-height: 1.6;
                color: var(--text);
              }
              
              .workout-exercises strong {
                color: var(--accent);
                font-weight: 600;
              }
              
              /* Calendar grid fix */
              .calendar-grid {
                display: grid !important;
                grid-template-columns: repeat(7, 1fr) !important;
                gap: 4px !important;
                margin-bottom: 16px !important;
                width: 100% !important;
              }
              
              /* Date picker popup size fix */
              .date-picker-popup {
                width: 320px !important;
                max-width: 90vw !important;
                right: auto !important;
              }
              
              .calendar-day {
                aspect-ratio: 1 !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                border-radius: 4px !important;
                cursor: pointer !important;
                font-size: 14px !important;
                transition: all 0.2s ease !important;
                min-height: 32px !important;
              }
              
              .calendar-day:hover {
                background: rgba(34,197,94,0.1) !important;
              }
              
              .calendar-day.selected {
                background: var(--accent) !important;
                color: white !important;
              }
              
              .calendar-day.in-range {
                background: rgba(34,197,94,0.2) !important;
                color: var(--accent) !important;
              }
              
              .calendar-day.other-month {
                color: var(--muted) !important;
                cursor: default !important;
              }
              
              .calendar-day.other-month:hover {
                background: none !important;
              }
              
              .calendar-day.header-day {
                cursor: default !important;
                pointer-events: none !important;
                font-weight: 600 !important;
                color: var(--muted) !important;
              }
              
              .calendar-day.header-day:hover {
                background: none !important;
              }
            `;
            document.head.appendChild(style);
            
            // Fix stats layout by modifying HTML structure
            const statsGrids = historyContent.querySelectorAll('.stats-grid');
            if (statsGrids.length >= 4) {
              // Create new structure with two rows
              const statsContainer = statsGrids[0].parentNode;
              const firstRow = document.createElement('div');
              firstRow.className = 'stats-grid';
              firstRow.style.cssText = 'display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 24px;';
              
              const secondRow = document.createElement('div');
              secondRow.className = 'stats-grid';
              secondRow.style.cssText = 'display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-top: 16px;';
              
              // Move first two stats to first row
              firstRow.appendChild(statsGrids[0].cloneNode(true));
              firstRow.appendChild(statsGrids[1].cloneNode(true));
              
              // Move last two stats to second row
              secondRow.appendChild(statsGrids[2].cloneNode(true));
              secondRow.appendChild(statsGrids[3].cloneNode(true));
              
              // Replace old structure
              statsGrids.forEach(grid => grid.remove());
              statsContainer.insertBefore(firstRow, statsContainer.firstChild);
              statsContainer.insertBefore(secondRow, firstRow.nextSibling);
            }
            
            // Re-initialize history page scripts
            initializeHistoryPage();
          }
        } catch (e) {
          historyContent.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--danger);">
              <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h3>
              <p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏—Å—Ç–æ—Ä–∏–∏</p>
            </div>
          `;
        }
      }
      
      async function loadSettingsPage() {
        const settingsContent = document.getElementById('settings-content');
        settingsContent.innerHTML = `
          <div style="text-align: center; padding: 40px;">
            <h3>–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫...</h3>
            <p>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∑–¥–µ—Å—å</p>
          </div>
        `;
        
        try {
          const response = await fetch(`./settings.html?v=${Date.now()}&cache=${Math.random()}`);
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          const html = await response.text();
          
          // Extract body content
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          const bodyContent = doc.body.querySelector('.container');
          
          if (bodyContent) {
            settingsContent.innerHTML = bodyContent.innerHTML;
            // Re-initialize settings page scripts
            initializeSettingsPage();
          } else {
            throw new Error('Settings content not found in HTML');
          }
        } catch (e) {
          console.error('Failed to load settings:', e);
          settingsContent.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--danger);">
              <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫</h3>
              <p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–∞—Å—Ç—Ä–æ–µ–∫: ${e.message}</p>
              <button onclick="clearCacheAndReload()" style="margin-top: 16px; padding: 8px 16px; background: var(--accent); color: white; border: none; border-radius: 4px; cursor: pointer;">
                üîÑ –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å
              </button>
            </div>
          `;
        }
      }
      
      function initializeHistoryPage() {
        // Initialize history page functionality
        const getStoredWorkouts = () => {
          try {
            return JSON.parse(localStorage.getItem('workouts') || '[]');
          } catch (e) {
            return [];
          }
        };

        const allWorkouts = getStoredWorkouts();
        let currentWorkouts = [...allWorkouts];
        
        function updateStats(workouts) {
          const totalWorkouts = workouts.length;
          const thisMonth = workouts.filter(w => {
            const workoutDate = new Date(w.date);
            const now = new Date();
            return workoutDate.getMonth() === now.getMonth() && 
                   workoutDate.getFullYear() === now.getFullYear();
          }).length;
          
          const totalSets = workouts.reduce((sum, w) => {
            return sum + w.exercises.reduce((exSum, ex) => exSum + ex.sets.length, 0);
          }, 0);
          
          const allWeights = workouts.flatMap(w => 
            w.exercises.flatMap(ex => 
              ex.sets.map(s => s.weight).filter(w => w !== null)
            )
          );
          const avgWeight = allWeights.length > 0 
            ? Math.round(allWeights.reduce((sum, w) => sum + w, 0) / allWeights.length)
            : 0;

          const totalWorkoutsEl = document.getElementById('totalWorkouts');
          const thisMonthEl = document.getElementById('thisMonth');
          const totalSetsEl = document.getElementById('totalSets');
          const avgWeightEl = document.getElementById('avgWeight');
          
          if (totalWorkoutsEl) totalWorkoutsEl.textContent = totalWorkouts;
          if (thisMonthEl) thisMonthEl.textContent = thisMonth;
          if (totalSetsEl) totalSetsEl.textContent = totalSets;
          if (avgWeightEl) avgWeightEl.textContent = avgWeight;
        }

        function renderWorkouts(workouts) {
          const historyList = document.getElementById('historyList');
          if (!historyList) return;
          
          if (workouts.length === 0) {
            historyList.innerHTML = `
              <div class="empty-state">
                <h3>–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</h3>
                <p>–ù–∞—á–Ω–∏—Ç–µ —Å –ø–µ—Ä–≤–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∑–¥–µ—Å—å –≤–∞—à–∏ –∑–∞–ø–∏—Å–∏</p>
              </div>
            `;
            return;
          }

          // Take only last 4 workouts and reverse to show newest first
          const recentWorkouts = workouts.slice(-4).reverse();
          
          historyList.innerHTML = recentWorkouts.map(workout => {
            const date = new Date(workout.date);
            const compactDate = date.toLocaleDateString('ru-RU', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric'
            });
            
            const exercisesHtml = workout.exercises.map(exercise => {
              const setsHtml = exercise.sets.map(set => {
                const weight = set.weight || 0;
                const reps = set.reps || 0;
                return `${weight}–∫–≥(${reps})`;
              }).join(' ');
              
              return `<strong>${exercise.exercise}:</strong> ${setsHtml}`;
            }).join('<br>');

            return `
              <div class="compact-workout-item">
                <div class="workout-date">${compactDate}</div>
                <div class="workout-exercises">${exercisesHtml}</div>
              </div>
            `;
          }).join('');
        }

        // Date range picker variables
        let selectedDateFrom = null;
        let selectedDateTo = null;
        let currentDate = new Date();
        let isSelectingFrom = true;

        function applyFilters() {
          const cycle = document.getElementById('filterCycle')?.value;
          const week = document.getElementById('filterWeek')?.value;
          const session = document.getElementById('filterSession')?.value;

          let filtered = [...allWorkouts];

          if (cycle) {
            filtered = filtered.filter(w => w.cycle === parseInt(cycle));
          }
          if (week) {
            filtered = filtered.filter(w => w.week === parseInt(week));
          }
          if (session) {
            filtered = filtered.filter(w => w.session === parseInt(session));
          }
          
          // Date range filter
          if (selectedDateFrom || selectedDateTo) {
            filtered = filtered.filter(w => {
              const workoutDate = new Date(w.date);
              const workoutDateStr = workoutDate.toISOString().split('T')[0];
              
              if (selectedDateFrom && selectedDateTo) {
                return workoutDateStr >= selectedDateFrom && workoutDateStr <= selectedDateTo;
              } else if (selectedDateFrom) {
                return workoutDateStr >= selectedDateFrom;
              } else if (selectedDateTo) {
                return workoutDateStr <= selectedDateTo;
              }
              return true;
            });
          }

          currentWorkouts = filtered;
          updateStats(filtered);
          renderWorkouts(filtered);
        }

        function clearFilters() {
          const filterCycle = document.getElementById('filterCycle');
          const filterWeek = document.getElementById('filterWeek');
          const filterSession = document.getElementById('filterSession');
          
          if (filterCycle) filterCycle.value = '';
          if (filterWeek) filterWeek.value = '';
          if (filterSession) filterSession.value = '';
          
          // Clear date range
          selectedDateFrom = null;
          selectedDateTo = null;
          updateDateRangeDisplay();
          hideDatePicker();
          
          currentWorkouts = [...allWorkouts];
          updateStats(currentWorkouts);
          renderWorkouts(currentWorkouts);
        }

        // Date range picker functions
        function showDatePicker() {
          const picker = document.getElementById('dateRangePicker');
          if (picker) {
            picker.style.display = 'block';
            renderCalendar();
          }
        }

        function hideDatePicker() {
          const picker = document.getElementById('dateRangePicker');
          if (picker) {
            picker.style.display = 'none';
          }
        }

        function updateDateRangeDisplay() {
          const input = document.getElementById('filterDateRange');
          if (!input) return;
          
          if (selectedDateFrom && selectedDateTo) {
            const fromDate = new Date(selectedDateFrom).toLocaleDateString('ru-RU');
            const toDate = new Date(selectedDateTo).toLocaleDateString('ru-RU');
            input.value = `${fromDate} - ${toDate}`;
          } else if (selectedDateFrom) {
            const fromDate = new Date(selectedDateFrom).toLocaleDateString('ru-RU');
            input.value = `–° ${fromDate}`;
          } else if (selectedDateTo) {
            const toDate = new Date(selectedDateTo).toLocaleDateString('ru-RU');
            input.value = `–î–æ ${toDate}`;
          } else {
            input.value = '';
          }
        }

        function renderCalendar() {
          const grid = document.getElementById('calendarGrid');
          const monthSpan = document.getElementById('currentMonth');
          if (!grid || !monthSpan) return;

          const year = currentDate.getFullYear();
          const month = currentDate.getMonth();
          
          monthSpan.textContent = new Date(year, month).toLocaleDateString('ru-RU', {
            month: 'long',
            year: 'numeric'
          });

          const firstDay = new Date(year, month, 1);
          const lastDay = new Date(year, month + 1, 0);
          const startDate = new Date(firstDay);
          startDate.setDate(startDate.getDate() - firstDay.getDay());

          let html = '';
          
          // Day headers
          const days = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
          days.forEach(day => {
            html += `<div class="calendar-day header-day" style="font-weight: 600; color: var(--muted); cursor: default;">${day}</div>`;
          });

          // Calendar days
          for (let i = 0; i < 42; i++) {
            const date = new Date(startDate);
            date.setDate(startDate.getDate() + i);
            
            const isCurrentMonth = date.getMonth() === month;
            const dateStr = date.toISOString().split('T')[0];
            const isSelected = dateStr === selectedDateFrom || dateStr === selectedDateTo;
            const isInRange = selectedDateFrom && selectedDateTo && 
                             dateStr >= selectedDateFrom && dateStr <= selectedDateTo;
            
            let classes = 'calendar-day';
            if (!isCurrentMonth) classes += ' other-month';
            if (isSelected) classes += ' selected';
            if (isInRange && !isSelected) classes += ' in-range';
            
            html += `<div class="${classes}" data-date="${dateStr}">${date.getDate()}</div>`;
          }

          grid.innerHTML = html;
          
          // Add click handlers
          grid.querySelectorAll('.calendar-day:not(.other-month):not(.header-day)').forEach(day => {
            day.addEventListener('click', handleDateClick);
          });
        }

        function handleDateClick(event) {
          const dateStr = event.target.dataset.date;
          if (!dateStr) return;

          if (isSelectingFrom) {
            selectedDateFrom = dateStr;
            selectedDateTo = null;
            isSelectingFrom = false;
          } else {
            if (dateStr < selectedDateFrom) {
              selectedDateTo = selectedDateFrom;
              selectedDateFrom = dateStr;
            } else {
              selectedDateTo = dateStr;
            }
            isSelectingFrom = true;
          }

          updateDateRangeDisplay();
          renderCalendar();
        }

        function applyDateRange() {
          hideDatePicker();
          applyFilters();
        }

        function clearDateRange() {
          selectedDateFrom = null;
          selectedDateTo = null;
          isSelectingFrom = true;
          updateDateRangeDisplay();
          renderCalendar();
        }

        // Event listeners
        const applyFiltersBtn = document.getElementById('applyFilters');
        const clearFiltersBtn = document.getElementById('clearFilters');
        
        if (applyFiltersBtn) applyFiltersBtn.addEventListener('click', applyFilters);
        if (clearFiltersBtn) clearFiltersBtn.addEventListener('click', clearFilters);

        // Date picker event listeners
        const dateRangeInput = document.getElementById('filterDateRange');
        const prevMonthBtn = document.getElementById('prevMonth');
        const nextMonthBtn = document.getElementById('nextMonth');
        const applyDateRangeBtn = document.getElementById('applyDateRange');
        const clearDateRangeBtn = document.getElementById('clearDateRange');

        if (dateRangeInput) {
          dateRangeInput.addEventListener('click', showDatePicker);
          dateRangeInput.addEventListener('focus', showDatePicker);
        }

        if (prevMonthBtn) {
          prevMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
          });
        }

        if (nextMonthBtn) {
          nextMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
          });
        }

        if (applyDateRangeBtn) {
          applyDateRangeBtn.addEventListener('click', applyDateRange);
        }

        if (clearDateRangeBtn) {
          clearDateRangeBtn.addEventListener('click', clearDateRange);
        }

        // Close picker when clicking outside
        document.addEventListener('click', (event) => {
          const picker = document.getElementById('dateRangePicker');
          const input = document.getElementById('filterDateRange');
          
          if (picker && !picker.contains(event.target) && !input.contains(event.target)) {
            hideDatePicker();
          }
        });

        // Initialize
        updateStats(currentWorkouts);
        renderWorkouts(currentWorkouts);
      }
      
      function initializeSettingsPage() {
        console.log('initializeSettingsPage called');
        
        // Configuration management
        const CONFIG_KEY = 'myfitness_config';
        
        let config = {
          yandexToken: '',
          yandexPath: '/MyFitness/workouts.json',
          autoSync: true,
          syncInterval: 15,
          defaultCycle: 1,
          theme: 'dark',
          userInfo: null,
          huggingFaceApiKey: '',
          aiModel: 'microsoft/BiomedCLIP-PubMedBERT_256-vit_base_patch16_224'
        };
        
        function loadConfig() {
          try {
            const saved = localStorage.getItem(CONFIG_KEY);
            if (saved) {
              config = { ...config, ...JSON.parse(saved) };
              applyConfigToUI();
            }
          } catch (e) {
            console.warn('Failed to load config:', e);
          }
        }
        
        function saveConfig() {
          try {
            const yandexPath = document.getElementById('yandexPath')?.value;
            const autoSync = document.getElementById('autoSync')?.checked;
            const syncInterval = parseInt(document.getElementById('syncInterval')?.value);
            const defaultCycle = parseInt(document.getElementById('defaultCycle')?.value);
            const theme = document.getElementById('theme')?.value;
            const huggingFaceApiKey = document.getElementById('huggingFaceApiKey')?.value;
            const aiModel = document.getElementById('aiModel')?.value;
            
            if (yandexPath !== undefined) config.yandexPath = yandexPath;
            if (autoSync !== undefined) config.autoSync = autoSync;
            if (syncInterval) config.syncInterval = syncInterval;
            if (defaultCycle) config.defaultCycle = defaultCycle;
            if (theme) config.theme = theme;
            if (huggingFaceApiKey !== undefined) config.huggingFaceApiKey = huggingFaceApiKey;
            if (aiModel) config.aiModel = aiModel;
            
            localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
            showStatus('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
          } catch (e) {
            console.warn('Failed to save config:', e);
            showStatus('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫', 'error');
          }
        }
        
        function applyConfigToUI() {
          const yandexPath = document.getElementById('yandexPath');
          const autoSync = document.getElementById('autoSync');
          const syncInterval = document.getElementById('syncInterval');
          const defaultCycle = document.getElementById('defaultCycle');
          const theme = document.getElementById('theme');
          const huggingFaceApiKey = document.getElementById('huggingFaceApiKey');
          const aiModel = document.getElementById('aiModel');
          
          if (yandexPath) yandexPath.value = config.yandexPath;
          if (autoSync) autoSync.checked = config.autoSync;
          if (syncInterval) syncInterval.value = config.syncInterval;
          if (defaultCycle) defaultCycle.value = config.defaultCycle;
          if (theme) theme.value = config.theme;
          if (huggingFaceApiKey) huggingFaceApiKey.value = config.huggingFaceApiKey || '';
          if (aiModel) aiModel.value = config.aiModel || 'microsoft/BiomedCLIP-PubMedBERT_256-vit_base_patch16_224';
          
          updateAuthStatus();
        }
        
        function showStatus(message, type = 'info') {
          const statusEl = document.getElementById('connectionStatus');
          if (statusEl) {
            statusEl.innerHTML = `<div class="status ${type}">${message}</div>`;
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
              statusEl.innerHTML = '';
            }, 5000);
          }
        }
        
        function updateAuthStatus() {
          const authStatus = document.getElementById('authStatus');
          const loginBtn = document.getElementById('loginBtn');
          const logoutBtn = document.getElementById('logoutBtn');
          
          if (config.userInfo) {
            if (authStatus) authStatus.innerHTML = `<div class="user-info">–í–æ—à–ª–∏ –∫–∞–∫: ${config.userInfo.real_name || config.userInfo.display_name || config.userInfo.login}</div>`;
            if (loginBtn) loginBtn.style.display = 'none';
            if (logoutBtn) logoutBtn.style.display = 'inline-block';
          } else {
            if (authStatus) authStatus.innerHTML = '<div class="user-info">–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã</div>';
            if (loginBtn) loginBtn.style.display = 'inline-block';
            if (logoutBtn) logoutBtn.style.display = 'none';
          }
        }
        
        function loginWithYandex() {
          console.log('loginWithYandex called from settings');
          const oauthUrl = `https://oauth.yandex.ru/authorize?response_type=token&client_id=07ca787a8f60406eab80bce2c2cf80c4&redirect_uri=${encodeURIComponent(window.location.origin + window.location.pathname)}`;
          console.log('OAuth URL:', oauthUrl);
          window.location.href = oauthUrl;
        }
        
        function logoutFromYandex() {
          config.yandexToken = '';
          config.userInfo = null;
          localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
          updateAuthStatus();
          showStatus('–í—ã—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω', 'info');
        }
        
        function exportData() {
          try {
            const workouts = JSON.parse(localStorage.getItem('workouts') || '[]');
            const dataStr = JSON.stringify(workouts, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `myfitness-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showStatus('–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'success');
          } catch (e) {
            showStatus('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö', 'error');
          }
        }
        
        function importData() {
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = '.json';
          
          input.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
              try {
                const data = JSON.parse(e.target.result);
                localStorage.setItem('workouts', JSON.stringify(data));
                showStatus('–î–∞–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'success');
              } catch (e) {
                showStatus('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞', 'error');
              }
            };
            reader.readAsText(file);
          };
          
          input.click();
        }
        
        function clearData() {
          if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
            localStorage.removeItem('workouts');
            showStatus('–í—Å–µ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã', 'success');
          }
        }
        
        // Test AI connection (internal, for dynamically loaded settings)
        async function testAiConnectionInternal() {
          try {
            const apiKeyElement = document.getElementById('huggingFaceApiKey');
            const modelElement = document.getElementById('aiModel');
            if (!apiKeyElement || !modelElement) {
              showStatus('–≠–ª–µ–º–µ–Ω—Ç—ã AI –Ω–∞—Å—Ç—Ä–æ–µ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'error');
              return;
            }
            const apiKey = apiKeyElement.value;
            const model = modelElement.value || 'microsoft/BiomedCLIP-PubMedBERT_256-vit_base_patch16_224';
            if (!apiKey) {
              showStatus('–í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è', 'error');
              return;
            }
            
            // Validate API key format
            if (!apiKey.startsWith('hf_')) {
              showStatus('API –∫–ª—é—á –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å "hf_"', 'error');
              return;
            }
            
            if (apiKey.length < 30) {
              showStatus('API –∫–ª—é—á —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π', 'error');
              return;
            }
            
            // Debug: show API key info (first 4 and last 4 chars)
            const keyStart = apiKey.substring(0, 4);
            const keyEnd = apiKey.substring(apiKey.length - 4);
            console.log(`Testing API key: ${keyStart}...${keyEnd} (length: ${apiKey.length})`);
            
            // Check for common issues
            if (apiKey.includes(' ')) {
              showStatus('API –∫–ª—é—á —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–æ–±–µ–ª—ã. –£–¥–∞–ª–∏—Ç–µ –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã.', 'error');
              return;
            }
            showStatus('–¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ AI...', 'info');
            
            // First, test if the API key is valid by checking user info
            try {
              const userResp = await fetch('https://huggingface.co/api/whoami', {
                headers: {
                  'Authorization': `Bearer ${apiKey}`
                }
              });
              
              console.log('User info response status:', userResp.status);
              
              if (userResp.ok) {
                const userInfo = await userResp.json();
                console.log('User info:', userInfo);
                showStatus(`–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ AI —É—Å–ø–µ—à–Ω–æ! –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${userInfo.name || 'Unknown'}`, 'success');
                return;
              } else {
                console.log('User info failed, trying model test...');
                if (userResp.status === 401) {
                  console.log('User API failed, trying Inference API directly...');
                  // Don't return here, try Inference API instead
                }
              }
            } catch (userErr) {
              console.log('User info test failed, trying model test...', userErr);
            }
            
            // Fallback: test with a simple, reliable model
            const testModel = 'gpt2'; // Simple, always available model
            
            console.log('Testing Inference API with model:', testModel);
            
            const resp = await fetch(`https://api-inference.huggingface.co/models/${testModel}`, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${apiKey}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                inputs: "Hello world"
              })
            });
            
            console.log('AI test response status:', resp.status);
            
            if (resp.ok) {
              const result = await resp.json();
              console.log('AI test response:', result);
              showStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ AI —É—Å–ø–µ—à–Ω–æ!', 'success');
            } else {
              const errorText = await resp.text();
              console.error('AI test error response:', errorText);
              showStatus(`–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${resp.status} - ${resp.statusText}`, 'error');
            }
          } catch (err) {
            console.error('AI connection test failed:', err);
            showStatus('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ AI —Å–µ—Ä–≤–∏—Å—É: ' + err.message, 'error');
          }
        }
        
        // Event listeners
        console.log('Setting up settings page event listeners...');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const syncNowBtn = document.getElementById('syncNow');
        const exportDataBtn = document.getElementById('exportData');
        const importDataBtn = document.getElementById('importData');
        const clearDataBtn = document.getElementById('clearData');
        // AI settings buttons (may or may not exist depending on template)
        const saveAiSettingsBtn = document.getElementById('saveAiSettings');
        const testAiConnectionBtn = document.getElementById('testAiConnection');
        
        console.log('loginBtn:', loginBtn);
        if (loginBtn) {
          loginBtn.addEventListener('click', loginWithYandex);
          console.log('Login button event listener added');
        }
        
        if (logoutBtn) logoutBtn.addEventListener('click', logoutFromYandex);
        if (syncNowBtn) syncNowBtn.addEventListener('click', () => {
          showStatus('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞...', 'info');
          setTimeout(() => {
            showStatus('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞', 'success');
          }, 2000);
        });
        if (exportDataBtn) exportDataBtn.addEventListener('click', exportData);
        if (importDataBtn) importDataBtn.addEventListener('click', importData);
        if (clearDataBtn) clearDataBtn.addEventListener('click', clearData);
        if (saveAiSettingsBtn) {
          // Reuse generic saveConfig which reads AI fields as well
          saveAiSettingsBtn.addEventListener('click', () => {
            saveConfig();
            showStatus('AI –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
          });
        }
        if (testAiConnectionBtn) {
          testAiConnectionBtn.addEventListener('click', testAiConnectionInternal);
        }
        
        // Auto-save on input changes
        [
          'yandexPath', 'autoSync', 'syncInterval', 'defaultCycle', 'theme', 'huggingFaceApiKey', 'aiModel'
        ].forEach(id => {
          const element = document.getElementById(id);
          if (element) {
            if (element.type === 'checkbox') {
              element.addEventListener('change', saveConfig);
            } else {
              element.addEventListener('blur', saveConfig);
            }
          }
        });
        
        // Initialize
        loadConfig();
      }
      
      // Cache clearing function
      async function clearCacheAndReload() {
        try {
          // Clear service worker cache
          if ('caches' in window) {
            const cacheNames = await caches.keys();
            await Promise.all(cacheNames.map(name => caches.delete(name)));
            console.log('Service worker cache cleared');
          }
          
          // Unregister service worker
          if ('serviceWorker' in navigator) {
            const registrations = await navigator.serviceWorker.getRegistrations();
            await Promise.all(registrations.map(reg => reg.unregister()));
            console.log('Service worker unregistered');
          }
          
          // Clear localStorage (optional - uncomment if needed)
          // localStorage.clear();
          
          // Force reload
          window.location.reload(true);
        } catch (error) {
          console.error('Error clearing cache:', error);
          window.location.reload(true);
        }
      }

      // Test Hugging Face token function
      async function testHuggingFaceToken() {
        const token = prompt('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à Hugging Face —Ç–æ–∫–µ–Ω –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:');
        if (!token) return;
        
        console.log('Testing token:', token.substring(0, 4) + '...' + token.substring(token.length - 4));
        
        try {
          const response = await fetch('https://huggingface.co/api/whoami', {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });
          
          console.log('Response status:', response.status);
          
          if (response.ok) {
            const userInfo = await response.json();
            console.log('User info:', userInfo);
            alert(`‚úÖ –¢–æ–∫–µ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç!\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${userInfo.name || 'Unknown'}`);
          } else {
            const errorText = await response.text();
            console.error('Error response:', errorText);
            alert(`‚ùå –û—à–∏–±–∫–∞: ${response.status} - ${response.statusText}`);
          }
        } catch (error) {
          console.error('Test failed:', error);
          alert(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`);
        }
      }

      // Initialize main page functionality
      const CONFIG_KEY = 'myfitness_config';
      const cycleEl = document.getElementById('cycle');
      const weekEl = document.getElementById('week');
      const sessionEl = document.getElementById('session');
      const addSetsToAllBtn = document.getElementById('addSetsToAll');
      const saveBtn = document.getElementById('saveWorkoutBtn');
      const syncBtn = document.getElementById('syncBtn');

      // –ì—Ä—É–ø–ø—ã –º—ã—à—Ü (–±–µ–∑ "–ó–∞–¥–Ω–∏–µ –¥–µ–ª—å—Ç—ã")
const groups = [
  { id: 'chest',     name: '–ì—Ä—É–¥—å',     ex: 'ex-chest',     setsContainer: 'sets-chest' },
  { id: 'back',      name: '–°–ø–∏–Ω–∞',     ex: 'ex-back',      setsContainer: 'sets-back' },
  { id: 'legs',      name: '–ù–æ–≥–∏',      ex: 'ex-legs',      setsContainer: 'sets-legs' },
  { id: 'shoulders', name: '–ü–ª–µ—á–∏',     ex: 'ex-shoulders', setsContainer: 'sets-shoulders' },
  { id: 'biceps',    name: '–ë–∏—Ü–µ–ø—Å',    ex: 'ex-biceps',    setsContainer: 'sets-biceps' },
  { id: 'triceps',   name: '–¢—Ä–∏—Ü–µ–ø—Å',   ex: 'ex-triceps',   setsContainer: 'sets-triceps' }
];

// –£–¥–∞–ª—è–µ–º —Å–µ–∫—Ü–∏—é "–ó–∞–¥–Ω–∏–µ –¥–µ–ª—å—Ç—ã" –∏–∑ DOM, –µ—Å–ª–∏ –µ—Å—Ç—å
(function removeRearDeltSection() {
  const sel = document.getElementById('ex-reardelt');
  if (sel) sel.closest('.wf-row')?.remove();
})();

// –î–æ–±–∞–≤–ª—è–µ–º "—Ä–∞–∑–≤–æ–¥–∫–∞ —Ä—É–∫ –≤ —Ç—Ä–µ–Ω–∞–∂–µ—Ä–µ-–±–∞–±–æ—á–∫–µ" –∫ –ø–ª–µ—á–∞–º
(function ensureShouldersOption() {
  const sel = document.getElementById('ex-shoulders');
  if (!sel) return;
  const exists = Array.from(sel.options).some(o =>
    o.textContent.trim().toLowerCase() === '—Ä–∞–∑–≤–æ–¥–∫–∞ —Ä—É–∫ –≤ —Ç—Ä–µ–Ω–∞–∂–µ—Ä–µ-–±–∞–±–æ—á–∫–µ'
  );
  if (!exists) {
    const opt = document.createElement('option');
    opt.textContent = '—Ä–∞–∑–≤–æ–¥–∫–∞ —Ä—É–∫ –≤ —Ç—Ä–µ–Ω–∞–∂–µ—Ä–µ-–±–∞–±–æ—á–∫–µ';
    sel.appendChild(opt);
  }
})();

// –ü–æ–¥–¥–µ—Ä–∂–∫–∞ "–¥—Ä—É–≥–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ"
function attachCustomExerciseHandler(selectEl) {
  if (!selectEl) return;
  // –¥–æ–±–∞–≤–ª—è–µ–º –ø—É–Ω–∫—Ç "–î—Ä—É–≥–æ–µ‚Ä¶"
  if (!Array.from(selectEl.options).some(o => o.value === '__custom__')) {
    const custom = document.createElement('option');
    custom.value = '__custom__';
    custom.textContent = '‚Äî –î—Ä—É–≥–æ–µ‚Ä¶ ‚Äî';
    selectEl.appendChild(custom);
  }
  selectEl.addEventListener('change', () => {
    if (selectEl.value === '__custom__') {
      const name = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è');
      if (name && name.trim()) {
        const val = name.trim();
        const opt = document.createElement('option');
        opt.value = val; opt.textContent = val;
        selectEl.add(opt);
        selectEl.value = val;
      } else {
        // –æ—Ç–∫–∞—Ç –∫ –ø–µ—Ä–≤–æ–º—É –ø—É–Ω–∫—Ç—É
        selectEl.selectedIndex = 0;
      }
    }
  });
}

// –°–æ–∑–¥–∞–Ω–∏–µ –±–ª–æ–∫–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ –≥—Ä—É–ø–ø—ã
function createExerciseBlock(groupId, optionsSourceSelect) {
  const container = document.getElementById(`group-${groupId}-exercises`);
  const index = container.querySelectorAll('.exercise-block').length;

  const block = document.createElement('div');
  block.className = 'exercise-block';

  // —Å–µ–ª–µ–∫—Ç —Å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è–º–∏ (–∫–æ–ø–∏—Ä—É–µ–º –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Å–µ–ª–µ–∫—Ç–∞)
  const header = document.createElement('div');
  header.className = 'exercise-header';

  const select = document.createElement('select');
  select.className = 'exercise-select';
  Array.from(optionsSourceSelect.options).forEach(o => {
    const opt = document.createElement('option');
    opt.text = o.text; opt.value = o.value || o.text;
    select.add(opt);
  });
  header.appendChild(select);

  const addSetIcon = document.createElement('button');
addSetIcon.type = 'button';
addSetIcon.className = 'icon-btn add-set-icon';
addSetIcon.title = '–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ö–æ–¥';
addSetIcon.textContent = '+';
addSetIcon.addEventListener('click', () => addSet(sets));
header.appendChild(addSetIcon);
  
  const removeBtn = document.createElement('button');
  removeBtn.type = 'button';
  removeBtn.className = 'remove-exercise';
  removeBtn.textContent = '√ó';
  removeBtn.title = '–£–¥–∞–ª–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ';
  removeBtn.addEventListener('click', () => block.remove());
  header.appendChild(removeBtn);

  block.appendChild(header);

   const sets = document.createElement('div');
  sets.className = 'sets';
  sets.id = `sets-${groupId}-${index}`;
  block.appendChild(sets);


  container.appendChild(block);

  attachCustomExerciseHandler(select);
  addSet(sets); // –Ω–∞—á–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥
}

// –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã –≤ "—Å–ø–∏—Å–æ–∫ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π"
function transformGroupsToMultiExercise() {
  groups.forEach(g => {
    const originalSelect = document.getElementById(g.ex);
    const originalSets = document.getElementById(g.setsContainer);
    if (!originalSelect || !originalSets) return;

    const row = originalSelect.closest('.wf-row');
    // –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
    const list = document.createElement('div');
    list.className = 'group-exercises';
    list.id = `group-${g.id}-exercises`;

    // –ø–µ—Ä–≤—ã–π –±–ª–æ–∫ —Ñ–æ—Ä–º–∏—Ä—É–µ–º –∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤, —á—Ç–æ–±—ã –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å
    const firstBlock = document.createElement('div');
    firstBlock.className = 'exercise-block';

    const header = document.createElement('div');
    header.className = 'exercise-header';
    originalSelect.classList.add('exercise-select');
    header.appendChild(originalSelect);

    const addSetIcon0 = document.createElement('button');
addSetIcon0.type = 'button';
addSetIcon0.className = 'icon-btn add-set-icon';
addSetIcon0.title = '–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ö–æ–¥';
addSetIcon0.textContent = '+';
addSetIcon0.addEventListener('click', () => addSet(originalSets));
header.appendChild(addSetIcon0);

    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'remove-exercise';
    removeBtn.textContent = '√ó';
    removeBtn.title = '–£–¥–∞–ª–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ';
    removeBtn.addEventListener('click', () => firstBlock.remove());
    header.appendChild(removeBtn);

    firstBlock.appendChild(header);

    originalSets.id = `sets-${g.id}-0`;
    firstBlock.appendChild(originalSets);

    list.appendChild(firstBlock);
    attachCustomExerciseHandler(originalSelect);

    // –ö–Ω–æ–ø–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ"
    const actions = document.createElement('div');
    actions.className = 'group-actions';
    const addExerciseBtn = document.createElement('button');
    addExerciseBtn.type = 'button';
    addExerciseBtn.className = 'btn-secondary';
    addExerciseBtn.textContent = '–î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ';
    addExerciseBtn.addEventListener('click', () => createExerciseBlock(g.id, originalSelect));
    actions.appendChild(addExerciseBtn);

    // –í—Å—Ç–∞–≤–ª—è–µ–º –∏ –æ—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
    row.appendChild(list);
    row.appendChild(actions);
  });
}

// –î–æ–±–∞–≤–∏—Ç—å –ø–æ –ø–æ–¥—Ö–æ–¥—É –≤–æ –≤—Å–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –≤–æ –≤—Å–µ—Ö –≥—Ä—É–ø–ø–∞—Ö
function addSetToAll() {
  document.querySelectorAll('.exercise-block .sets').forEach(container => addSet(container));
}

// –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏: —É—á–∏—Ç—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
function collectCurrentEntry() {
  const cycle = Number(document.getElementById('cycle').value) || 1;
  const week = Number(document.getElementById('week').value);
  const session = Number(document.getElementById('session').value);

  const exercises = selectedExercises.map(exercise => {
    const setsContainer = document.getElementById(`sets-${exercise.id}`);
    const sets = [];
    
    if (setsContainer) {
      setsContainer.querySelectorAll('.set-row').forEach(row => {
        const repsInput = row.querySelector('.reps-input');
        const weightInput = row.querySelector('.weight-input');
        
        const repsVal = Number(repsInput?.value);
        const weightVal = Number(weightInput?.value);
        
        sets.push({
          reps: Number.isFinite(repsVal) ? repsVal : null,
          weight: Number.isFinite(weightVal) ? weightVal : null
        });
      });
    }
    
    return {
      group: exercise.group,
      exercise: exercise.name,
      sets
    };
  });

  return {
    id: generateUUID(),
    date: new Date().toISOString(),
    updatedAt: new Date().toISOString(),
    deviceId: getDeviceId(),
    cycle, week, session,
    exercises
  };
}

      // App config (synced with settings page)
      let appConfig = {
        yandexToken: '',
        yandexPath: '/MyFitness/workouts.json',
        autoSync: false,
        syncInterval: 15,
        userInfo: null
      };

      function loadConfig() {
        try {
          const saved = localStorage.getItem(CONFIG_KEY);
          if (saved) {
            appConfig = { ...appConfig, ...JSON.parse(saved) };
          }
        } catch (e) {
          console.warn('Failed to load config:', e);
        }
      }

      // OAuth flow
      const YANDEX_OAUTH_URL = 'https://oauth.yandex.ru/authorize';
      const CLIENT_ID = '07ca787a8f60406eab80bce2c2cf80c4';
      const REDIRECT_URI = window.location.origin + window.location.pathname;

      function getOAuthUrl() {
        const params = new URLSearchParams({
          response_type: 'token',
          client_id: CLIENT_ID,
          redirect_uri: REDIRECT_URI
        });
        return `${YANDEX_OAUTH_URL}?${params}`;
      }

      function handleOAuthCallback() {
        const hash = window.location.hash.substring(1);
        const params = new URLSearchParams(hash);
        const accessToken = params.get('access_token');
        const error = params.get('error');

        if (error) {
          showStatus(`–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${error}`, 'error');
          return;
        }

        if (accessToken) {
          appConfig.yandexToken = accessToken;
          localStorage.setItem(CONFIG_KEY, JSON.stringify(appConfig));
          showStatus('–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!', 'success');
          // Clear hash from URL
          window.history.replaceState(null, '', window.location.pathname);
          // Get user info and start sync
          getUserInfo(accessToken);
        }
      }

      async function getUserInfo(token) {
        try {
          const response = await fetch('https://login.yandex.ru/info', {
            headers: { 'Authorization': `OAuth ${token}` }
          });
          if (response.ok) {
            appConfig.userInfo = await response.json();
            localStorage.setItem(CONFIG_KEY, JSON.stringify(appConfig));
            // Start sync after successful auth
            await syncWorkoutsToYandex();
          }
        } catch (e) {
          console.warn('Failed to get user info:', e);
        }
      }

      function logout() {
        appConfig.yandexToken = '';
        appConfig.userInfo = null;
        localStorage.setItem(CONFIG_KEY, JSON.stringify(appConfig));
        showStatus('–í—ã—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω', 'info');
      }

      // Simple UUID v4 generator
      function generateUUID() {
        if (crypto && crypto.randomUUID) return crypto.randomUUID();
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
          const r = Math.random() * 16 | 0; const v = c === 'x' ? r : (r & 0x3 | 0x8);
          return v.toString(16);
        });
      }

      // Persistent device id
      function getDeviceId() {
        const key = 'myfitness_device_id';
        let id = localStorage.getItem(key);
        if (!id) { id = generateUUID(); localStorage.setItem(key, id); }
        return id;
      }

      function getWorkouts() {
        try { return JSON.parse(localStorage.getItem('workouts') || '[]'); }
        catch { return []; }
      }

      function setWorkouts(workouts) {
        localStorage.setItem('workouts', JSON.stringify(workouts));
      }

      async function syncWorkoutsToYandex(optionalWorkouts) {
        const token = appConfig.yandexToken?.trim();
        const path = appConfig.yandexPath?.trim() || '/MyFitness/workouts.json';
        console.log('Sync path:', path);
        console.log('App config:', appConfig);
        if (!token || !path) {
          showStatus('–£–∫–∞–∂–∏—Ç–µ OAuth —Ç–æ–∫–µ–Ω –∏ –ø—É—Ç—å –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö', 'error');
          return false;
        }
        try {
          // 0) Ensure MyFitness folder exists
          const folderPath = '/MyFitness';
          try {
            const folderCheckResp = await fetch(`https://cloud-api.yandex.net/v1/disk/resources?path=${encodeURIComponent(folderPath)}`, {
              headers: { 'Authorization': `OAuth ${token}` }
            });
            
            if (folderCheckResp.status === 404) {
              // Folder doesn't exist, create it
              console.log('Creating MyFitness folder...');
              const createFolderResp = await fetch(`https://cloud-api.yandex.net/v1/disk/resources?path=${encodeURIComponent(folderPath)}`, {
                method: 'PUT',
                headers: { 'Authorization': `OAuth ${token}` }
              });
              
              if (!createFolderResp.ok) {
                console.warn('Failed to create MyFitness folder:', createFolderResp.status);
              } else {
                console.log('MyFitness folder created successfully');
              }
            }
          } catch (e) {
            console.warn('Failed to check/create MyFitness folder:', e);
          }
          
          // 1) Check if file exists, then download via API
          let remoteWorkouts = [];
          try {
            // First check if file exists
            const checkResp = await fetch(`https://cloud-api.yandex.net/v1/disk/resources?path=${encodeURIComponent(path)}`, {
              headers: { 'Authorization': `OAuth ${token}` }
            });
            
            if (checkResp.ok) {
              // File exists, try to get its content via API
              const downloadResp = await fetch(`https://cloud-api.yandex.net/v1/disk/resources/download?path=${encodeURIComponent(path)}`, {
                headers: { 'Authorization': `OAuth ${token}` }
              });
              
              if (downloadResp.ok) {
                const { href: downloadHref } = await downloadResp.json();
                if (downloadHref) {
                  // Use proxy approach or skip download for now
                  console.log('File exists but direct download blocked by CORS. Starting with local data.');
                  remoteWorkouts = [];
                }
              }
            } else if (checkResp.status === 404) {
              // File doesn't exist, start with empty array
              console.log('Remote file not found, starting with empty array');
              remoteWorkouts = [];
            }
          } catch (e) {
            console.warn('Failed to check remote file, starting with empty array:', e);
            remoteWorkouts = [];
          }

          const localWorkouts = optionalWorkouts ?? getWorkouts();
          const merged = mergeWorkouts(remoteWorkouts, localWorkouts);
          setWorkouts(merged);

          // Try to upload with overwrite first
          let uploadLinkResp = await fetch(`https://cloud-api.yandex.net/v1/disk/resources/upload?path=${encodeURIComponent(path)}&overwrite=true`, {
            headers: { 'Authorization': `OAuth ${token}` }
          });
          
          // If 409 conflict, try without overwrite (create new file)
          if (uploadLinkResp.status === 409) {
            console.log('File conflict detected, trying to create new file...');
            uploadLinkResp = await fetch(`https://cloud-api.yandex.net/v1/disk/resources/upload?path=${encodeURIComponent(path)}`, {
              headers: { 'Authorization': `OAuth ${token}` }
            });
            
            // If still conflict, try with timestamp
            if (uploadLinkResp.status === 409) {
              console.log('Still conflict, trying with timestamp...');
              const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
              const backupPath = path.replace('.json', `-${timestamp}.json`);
              uploadLinkResp = await fetch(`https://cloud-api.yandex.net/v1/disk/resources/upload?path=${encodeURIComponent(backupPath)}`, {
                headers: { 'Authorization': `OAuth ${token}` }
              });
              
              if (uploadLinkResp.ok) {
                console.log('Created backup file with timestamp');
                showStatus('–°–æ–∑–¥–∞–Ω —Ä–µ–∑–µ—Ä–≤–Ω—ã–π —Ñ–∞–π–ª —Å –≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ—Ç–∫–æ–π', 'info');
              }
            }
          }
          
          if (!uploadLinkResp.ok) {
            const msg = `–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è upload URL: ${uploadLinkResp.status}`;
            console.error('Upload error details:', uploadLinkResp.statusText);
            showStatus(msg, 'error');
            return false;
          }
          
          const { href } = await uploadLinkResp.json();
          if (!href) { 
            showStatus('–ù–µ –ø–æ–ª—É—á–µ–Ω–∞ —Å—Å—ã–ª–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', 'error'); 
            return false; 
          }

          showStatus('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫–æ–º...', 'info');
          const putResp = await fetch(href, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(merged, null, 2)
          });
          
          if (!putResp.ok) {
            console.error('PUT request failed:', putResp.status, putResp.statusText);
            showStatus(`–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏: ${putResp.status}`, 'error');
            return false;
          }
          showStatus('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞', 'success');
          return true;
        } catch (e) {
          showStatus(`–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: ${e.message}`, 'error');
          return false;
        }
      }

      function mergeWorkouts(remote, local) {
        const byId = new Map();
        [...remote, ...local].forEach(item => {
          if (!item || !item.id) return;
          const prev = byId.get(item.id);
          if (!prev) { byId.set(item.id, item); return; }
          const prevTs = Date.parse(prev.updatedAt || prev.date || 0);
          const curTs = Date.parse(item.updatedAt || item.date || 0);
          if (curTs >= prevTs) byId.set(item.id, item);
        });
        const merged = Array.from(byId.values());
        merged.sort((a,b) => Date.parse(a.date||0) - Date.parse(b.date||0));
        return merged;
      }

      let autoSyncTimer = null;
      function startAutoSyncTimer() {
        if (autoSyncTimer) { clearInterval(autoSyncTimer); autoSyncTimer = null; }
        if (appConfig.autoSync && appConfig.syncInterval > 0) {
          autoSyncTimer = setInterval(() => {
            syncWorkoutsToYandex().catch(() => {});
          }, Math.max(1, appConfig.syncInterval) * 60 * 1000);
        }
      }

      function createSetRow(index) {
        const row = document.createElement('div');
        row.className = 'set-row';
        row.innerHTML = `
          <span class="em-label">–ü–æ–¥—Ö–æ–¥ ${index + 1}</span>
          <div class="pair"><span class="em-label">–ü–æ–≤—Ç.</span><input type="number" class="reps" min="1" max="50" placeholder="10" /></div>
          <div class="pair"><span class="em-label">–í–µ—Å</span><input type="number" class="weight" min="0" max="700" step="0.5" placeholder="–∫–≥" /></div>
          <button type="button" class="remove-set" title="–£–¥–∞–ª–∏—Ç—å">√ó</button>
        `;
        return row;
      }

      function addSet(container) {
        const index = container.querySelectorAll('.set-row').length;
        const row = createSetRow(index);
        container.appendChild(row);
        row.querySelector('.remove-set').addEventListener('click', () => {
          row.remove();
          renumberSets(container);
        });
      }

      function renumberSets(container) {
        container.querySelectorAll('.set-row .em-label:first-child').forEach((el, idx) => {
          el.textContent = `–ü–æ–¥—Ö–æ–¥ ${idx + 1}`;
        });
      }

      // Ensure at least one set exists in each exercise block (after transform)
      function ensureInitialSetsMulti() {
        document.querySelectorAll('.exercise-block .sets').forEach(container => {
          if (!container.querySelector('.set-row')) addSet(container);
        });
      }

      

      async function handleSave() {
        console.log('handleSave called');
        
        if (!cycleEl.value) {
          alert('–£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä —Ü–∏–∫–ª–∞');
          return;
        }

        const entry = collectCurrentEntry();
        console.log('Collected entry:', entry);

        const hasAnySet = entry.exercises.some(ex => ex.sets.some(s => (s.reps && s.reps > 0) || (s.weight && s.weight > 0)));
        console.log('Has any set:', hasAnySet);
        
        if (!hasAnySet) {
          if (!confirm('–í—ã –Ω–µ —É–∫–∞–∑–∞–ª–∏ –Ω–∏ –æ–¥–∏–Ω –ø–æ–¥—Ö–æ–¥. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å?')) return;
        }

        try {
          saveBtn.disabled = true;
          saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
          
          // Save locally first
          const current = getWorkouts();
          console.log('Current workouts:', current);
          current.push(entry);
          setWorkouts(current);
          console.log('Saved workouts:', current);
          
          showStatus('–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!', 'success');
          
          // Auto-sync to Yandex Disk if enabled
          if (appConfig.autoSync) {
            console.log('Auto-sync enabled, syncing...');
            await syncWorkoutsToYandex(current);
          } else {
            console.log('Auto-sync disabled');
          }

          // Update welcome page statistics if it's visible
          if (document.getElementById('welcome-page').style.display !== 'none') {
            loadWelcomePage();
          }
          
          // Clear form
          cycleEl.value = '';
          selectedExercises = [];
          renderExerciseGrid();
          renderSelectedExercises();
          updateSelectedCounter();
          
        } catch (e) {
          console.error('Save failed:', e);
          showStatus(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${e.message}`, 'error');
        } finally {
          saveBtn.disabled = false;
          saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É';
        }
      }

      function addSetToAll() {
        document.querySelectorAll('.exercise-block .sets').forEach(container => addSet(container));
      }

      function showStatus(message, type = 'info') {
        // Create status element if it doesn't exist
        let statusEl = document.querySelector('.workout-form .status');
        if (!statusEl) {
          statusEl = document.createElement('div');
          statusEl.className = 'status';
          document.querySelector('.workout-form').insertBefore(statusEl, document.querySelector('.wf-actions'));
        }
        
        statusEl.className = `status ${type}`;
        statusEl.textContent = message;
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
          statusEl.remove();
        }, 5000);
      }

      // Wire per-group add buttons
      document.querySelectorAll('.add-set-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const targetId = btn.getAttribute('data-target');
          const container = document.getElementById(targetId);
          addSet(container);
        });
      });

      // Event listeners
      console.log('Setting up event listeners...');
      console.log('saveBtn:', saveBtn);
      saveBtn.addEventListener('click', handleSave);
      console.log('Save button event listener added');
      addSetsToAllBtn.addEventListener('click', addSetToAll);
      syncBtn.addEventListener('click', () => { syncWorkoutsToYandex().catch(() => {}); });

// Initialize
loadConfig();
startAutoSyncTimer();

// Handle OAuth callback on page load
if (window.location.hash.includes('access_token')) {
  handleOAuthCallback();
}

          // Pull from Yandex on startup to merge latest remote with local
          (async function initialPull(){
            if (appConfig.yandexToken && appConfig.yandexPath) {
              try {
                await syncWorkoutsToYandex(); // performs download->merge->upload
              } catch (e) {
                console.warn('Initial sync failed, continuing with local data:', e);
              }
            }
          })();

// React to settings updates from Settings page (if open in another tab)
window.addEventListener('storage', (e) => {
  if (e.key === CONFIG_KEY) {
    loadConfig();
    startAutoSyncTimer();
  }
});
transformGroupsToMultiExercise();
document.querySelectorAll('.add-set-btn').forEach(btn => btn.remove()); // —É–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–Ω–æ–ø–∫–∏
ensureInitialSetsMulti();

// Initialize welcome page
loadWelcomePage();

// Exercise selection functions
function initializeExerciseSelection() {
  renderExerciseGrid();
  setupExerciseEventListeners();
}

function renderExerciseGrid() {
  const grid = document.getElementById('exerciseGrid');
  if (!grid) return;

  const filteredExercises = getFilteredExercises();
  
  grid.innerHTML = filteredExercises.map(exercise => `
    <div class="exercise-card ${isExerciseSelected(exercise.id) ? 'selected' : ''}" data-exercise-id="${exercise.id}">
      <div class="exercise-name">${exercise.name}</div>
      <div class="exercise-group">${exercise.group}</div>
      <div class="exercise-tags">
        ${exercise.tags.map(tag => `<span class="exercise-tag">${tag}</span>`).join('')}
      </div>
    </div>
  `).join('');
}

function getFilteredExercises() {
  let filtered = exercises;

  // Apply search filter
  if (searchQuery) {
    filtered = filtered.filter(exercise => 
      exercise.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
      exercise.group.toLowerCase().includes(searchQuery.toLowerCase()) ||
      exercise.tags.some(tag => tag.toLowerCase().includes(searchQuery.toLowerCase()))
    );
  }

  // Apply filter buttons
  if (currentFilter === 'popular') {
    filtered = filtered.filter(exercise => exercise.isPopular);
  } else if (currentFilter === 'recent') {
    // Get recent exercises from localStorage
    const recentExercises = JSON.parse(localStorage.getItem('recentExercises') || '[]');
    filtered = filtered.filter(exercise => recentExercises.includes(exercise.id));
  }

  // Apply group filter
  if (currentGroupFilter) {
    filtered = filtered.filter(exercise => exercise.group === currentGroupFilter);
  }

  return filtered;
}

function isExerciseSelected(exerciseId) {
  return selectedExercises.some(ex => ex.id === exerciseId);
}

function setupExerciseEventListeners() {
  // Search input
  const searchInput = document.getElementById('exerciseSearch');
  if (searchInput) {
    searchInput.addEventListener('input', (e) => {
      searchQuery = e.target.value;
      renderExerciseGrid();
    });
  }

  // Filter buttons
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      e.target.classList.add('active');
      currentFilter = e.target.dataset.filter;
      renderExerciseGrid();
    });
  });

  // Group filter buttons
  document.querySelectorAll('.group-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const group = e.target.dataset.group;
      if (currentGroupFilter === group) {
        currentGroupFilter = null;
        e.target.classList.remove('active');
      } else {
        document.querySelectorAll('.group-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        currentGroupFilter = group;
      }
      renderExerciseGrid();
    });
  });

  // Exercise cards
  document.addEventListener('click', (e) => {
    const card = e.target.closest('.exercise-card');
    if (card) {
      const exerciseId = card.dataset.exerciseId;
      toggleExerciseSelection(exerciseId);
    }
  });
}

function toggleExerciseSelection(exerciseId) {
  const exercise = exercises.find(ex => ex.id === exerciseId);
  if (!exercise) return;

  const isSelected = isExerciseSelected(exerciseId);
  
  if (isSelected) {
    // Remove exercise
    selectedExercises = selectedExercises.filter(ex => ex.id !== exerciseId);
  } else {
    // Add exercise (max 8)
    if (selectedExercises.length >= 8) {
      showStatus('–ú–∞–∫—Å–∏–º—É–º 8 —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ', 'error');
      return;
    }
    selectedExercises.push({
      id: exercise.id,
      name: exercise.name,
      group: exercise.group,
      sets: []
    });
    
    // Add to recent exercises
    addToRecentExercises(exerciseId);
  }

  renderExerciseGrid();
  renderSelectedExercises();
  updateSelectedCounter();
}

function addToRecentExercises(exerciseId) {
  const recent = JSON.parse(localStorage.getItem('recentExercises') || '[]');
  const updated = [exerciseId, ...recent.filter(id => id !== exerciseId)].slice(0, 10);
  localStorage.setItem('recentExercises', JSON.stringify(updated));
}

function renderSelectedExercises() {
  const container = document.getElementById('selectedExercises');
  if (!container) return;

  if (selectedExercises.length === 0) {
    container.innerHTML = '<p style="text-align: center; color: var(--muted);">–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</p>';
    return;
  }

  container.innerHTML = selectedExercises.map((exercise, index) => `
    <div class="selected-exercise-item" data-exercise-index="${index}">
      <div class="selected-exercise-header">
        <div class="selected-exercise-name">${exercise.name}</div>
        <button class="remove-exercise-btn" onclick="removeSelectedExercise(${index})">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
      <div class="selected-exercise-sets" id="sets-${exercise.id}">
        <!-- Sets will be added here -->
      </div>
      <button type="button" class="btn-secondary add-set-btn" data-target="sets-${exercise.id}">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ö–æ–¥</button>
    </div>
  `).join('');

  // Reinitialize set buttons
  document.querySelectorAll('.add-set-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const targetId = e.target.dataset.target;
      addSetToExercise(targetId);
    });
  });
}

function removeSelectedExercise(index) {
  selectedExercises.splice(index, 1);
  renderExerciseGrid();
  renderSelectedExercises();
  updateSelectedCounter();
}

function updateSelectedCounter() {
  const counter = document.getElementById('selectedCount');
  if (counter) {
    counter.textContent = selectedExercises.length;
  }
}

function addSetToExercise(targetId) {
  const setsContainer = document.getElementById(targetId);
  if (!setsContainer) return;

  const setIndex = setsContainer.children.length;
  const setHtml = `
    <div class="set-row">
      <span class="em-label">–ü–æ–¥—Ö–æ–¥ ${setIndex + 1}:</span>
      <div class="pair">
        <input type="number" placeholder="–ü–æ–≤—Ç–æ—Ä—ã" min="1" max="100" class="reps-input" data-set-index="${setIndex}">
        <input type="number" placeholder="–í–µ—Å (–∫–≥)" min="0" max="500" class="weight-input" data-set-index="${setIndex}">
      </div>
      <button type="button" class="remove-set" onclick="removeSet(this)">√ó</button>
    </div>
  `;
  setsContainer.insertAdjacentHTML('beforeend', setHtml);
}

function removeSet(button) {
  button.closest('.set-row').remove();
  // Renumber remaining sets
  const container = button.closest('.selected-exercise-sets');
  container.querySelectorAll('.set-row').forEach((row, index) => {
    row.querySelector('.em-label').textContent = `–ü–æ–¥—Ö–æ–¥ ${index + 1}:`;
    row.querySelectorAll('input').forEach(input => {
      input.dataset.setIndex = index;
    });
  });
}

// Initialize exercise selection when main page is loaded
function loadMainPage() {
  initializeExerciseSelection();
}

// Body Analysis Functions
let currentPhoto = null;
let currentAnalysis = null;

// Hugging Face API configuration
const HUGGING_FACE_BASE_URL = 'https://api-inference.huggingface.co/models/';

// Body analysis prompts for better results
const BODY_ANALYSIS_PROMPTS = [
  'body fat percentage estimation',
  'body composition analysis',
  'fitness level assessment',
  'muscle mass evaluation',
  'overall body health'
];

function loadBodyAnalysisPage() {
  setupPhotoUpload();
  loadAnalysisHistory();
  
  // Initialize charts with existing data
  const analyses = JSON.parse(localStorage.getItem('bodyAnalyses') || '[]');
  if (analyses.length > 0) {
    updateProgressCharts(analyses);
  }
}

function setupPhotoUpload() {
  const uploadArea = document.getElementById('uploadArea');
  const photoInput = document.getElementById('photoInput');

  // Click to upload
  uploadArea.addEventListener('click', () => {
    photoInput.click();
  });

  // File selection
  photoInput.addEventListener('change', handlePhotoSelect);

  // Drag and drop
  uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
  });

  uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
  });

  uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      handlePhotoFile(files[0]);
    }
  });
}

function handlePhotoSelect(e) {
  const file = e.target.files[0];
  if (file) {
    handlePhotoFile(file);
  }
}

function handlePhotoFile(file) {
  if (!file.type.startsWith('image/')) {
    showAnalysisStatus('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ', 'error');
    return;
  }

  const reader = new FileReader();
  reader.onload = (e) => {
    currentPhoto = {
      file: file,
      dataUrl: e.target.result
    };
    showPhotoPreview(e.target.result);
    document.getElementById('analyzeBtn').disabled = false;
  };
  reader.readAsDataURL(file);
}

function showPhotoPreview(dataUrl) {
  document.getElementById('uploadArea').style.display = 'none';
  document.getElementById('photoPreview').style.display = 'block';
  document.getElementById('previewImage').src = dataUrl;
}

function retakePhoto() {
  currentPhoto = null;
  document.getElementById('uploadArea').style.display = 'block';
  document.getElementById('photoPreview').style.display = 'none';
  document.getElementById('analyzeBtn').disabled = true;
  document.getElementById('saveBtn').disabled = true;
  document.getElementById('analysisResults').style.display = 'none';
}

async function analyzeBody() {
  if (!currentPhoto) return;

  const analyzeBtn = document.getElementById('analyzeBtn');
  analyzeBtn.disabled = true;
  analyzeBtn.textContent = '–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º...';

  try {
    // Try real AI analysis first, fallback to simulation
    let analysis;
    try {
      analysis = await analyzeBodyWithAI(currentPhoto);
      showAnalysisStatus('AI –∞–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
    } catch (aiError) {
      console.warn('AI analysis failed, using simulation:', aiError);
      analysis = await simulateBodyAnalysis(currentPhoto);
      showAnalysisStatus('–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–∏–º—É–ª—è—Ü–∏—è (AI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)', 'info');
    }
    
    currentAnalysis = analysis;
    showAnalysisResults(analysis);
    document.getElementById('saveBtn').disabled = false;
    
  } catch (error) {
    showAnalysisStatus('–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: ' + error.message, 'error');
  } finally {
    analyzeBtn.disabled = false;
    analyzeBtn.textContent = 'üîç –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ç–æ';
  }
}

async function analyzeBodyWithAI(photo) {
  console.log('Starting AI analysis with Hugging Face...');
  
  // Get settings from config
  const apiKey = appConfig.huggingFaceApiKey;
  const model = appConfig.aiModel || 'microsoft/BiomedCLIP-PubMedBERT_256-vit_base_patch16_224';
  
  if (!apiKey) {
    throw new Error('API –∫–ª—é—á Hugging Face –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–±–∞–≤—å—Ç–µ –∫–ª—é—á –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.');
  }
  
  try {
    // Convert image to base64
    const base64Image = photo.dataUrl.split(',')[1];
    
    // Prepare the request - BiomedCLIP expects different format
    const apiUrl = HUGGING_FACE_BASE_URL + model;
    const requestBody = {
      inputs: {
        image: base64Image,
        text: BODY_ANALYSIS_PROMPTS.join(', ')
      }
    };
    
    console.log('Sending request to:', apiUrl);
    console.log('Request body keys:', Object.keys(requestBody.inputs));
    
    const response = await fetch(apiUrl, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${apiKey}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(requestBody)
    });
    
    if (!response.ok) {
      throw new Error(`API –æ—à–∏–±–∫–∞: ${response.status} ${response.statusText}`);
    }
    
    const result = await response.json();
    console.log('AI analysis result:', result);
    
    // Process AI result and convert to our format
    return processAIResult(result);
    
  } catch (error) {
    console.error('AI analysis failed:', error);
    throw error;
  }
}

function processAIResult(aiResult) {
  console.log('Processing AI result:', aiResult);
  
  // Extract relevant information from AI response
  // This will depend on the specific model output format
  let fatPercentage = 15; // Default fallback
  let confidence = 0.7;
  
  // Try to extract fat percentage from AI response
  if (aiResult && aiResult.length > 0) {
    // Look for fat percentage in the response
    const fatMatch = JSON.stringify(aiResult).match(/(\d+(?:\.\d+)?)\s*%?\s*(?:–∂–∏—Ä|fat)/i);
    if (fatMatch) {
      fatPercentage = parseFloat(fatMatch[1]);
    }
    
    // Extract confidence if available
    if (aiResult[0] && aiResult[0].score) {
      confidence = aiResult[0].score;
    }
  }
  
  // Determine level and recommendations based on fat percentage
  let level, recommendations;
  
  if (fatPercentage < 12) {
    level = '–û—á–µ–Ω—å –Ω–∏–∑–∫–∏–π';
    recommendations = '–û—Ç–ª–∏—á–Ω–∞—è —Ñ–æ—Ä–º–∞! –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ —Ç–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.';
  } else if (fatPercentage < 18) {
    level = '–ù–∏–∑–∫–∏–π';
    recommendations = '–•–æ—Ä–æ—à–∞—è —Ñ–æ—Ä–º–∞. –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–∏–ª–æ–≤—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏.';
  } else if (fatPercentage < 25) {
    level = '–°—Ä–µ–¥–Ω–∏–π';
    recommendations = '–ù–æ—Ä–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∫–∞—Ä–¥–∏–æ + —Å–∏–ª–æ–≤—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏.';
  } else {
    level = '–í—ã—Å–æ–∫–∏–π';
    recommendations = '–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–Ω–∏–∑–∏—Ç—å –ø—Ä–æ—Ü–µ–Ω—Ç –∂–∏—Ä–∞ —á–µ—Ä–µ–∑ –¥–∏–µ—Ç—É –∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏.';
  }
  
  return {
    fatPercentage: Math.round(fatPercentage * 10) / 10,
    level,
    recommendations,
    confidence: Math.round(confidence * 100),
    timestamp: new Date().toISOString(),
    aiModel: 'Hugging Face BiomedCLIP'
  };
}

async function simulateBodyAnalysis(photo) {
  // Fallback to simulation if AI is not available
  console.log('Using simulation as fallback...');
  
  // Simulate API delay
  await new Promise(resolve => setTimeout(resolve, 2000));
  
  // Generate random fat percentage (replace with real AI analysis)
  const fatPercentage = Math.round((Math.random() * 20 + 8) * 10) / 10; // 8-28%
  
  let level, recommendations;
  
  if (fatPercentage < 12) {
    level = '–û—á–µ–Ω—å –Ω–∏–∑–∫–∏–π';
    recommendations = '–û—Ç–ª–∏—á–Ω–∞—è —Ñ–æ—Ä–º–∞! –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ —Ç–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.';
  } else if (fatPercentage < 18) {
    level = '–ù–∏–∑–∫–∏–π';
    recommendations = '–•–æ—Ä–æ—à–∞—è —Ñ–æ—Ä–º–∞. –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–∏–ª–æ–≤—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏.';
  } else if (fatPercentage < 25) {
    level = '–°—Ä–µ–¥–Ω–∏–π';
    recommendations = '–ù–æ—Ä–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∫–∞—Ä–¥–∏–æ + —Å–∏–ª–æ–≤—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏.';
  } else {
    level = '–í—ã—Å–æ–∫–∏–π';
    recommendations = '–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–Ω–∏–∑–∏—Ç—å –ø—Ä–æ—Ü–µ–Ω—Ç –∂–∏—Ä–∞ —á–µ—Ä–µ–∑ –¥–∏–µ—Ç—É –∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏.';
  }
  
  return {
    fatPercentage,
    level,
    recommendations,
    confidence: 85,
    timestamp: new Date().toISOString(),
    aiModel: 'Simulation (API –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)'
  };
}

function showAnalysisResults(analysis) {
  document.getElementById('fatPercentage').textContent = analysis.fatPercentage + '%';
  document.getElementById('fatLevel').textContent = analysis.level;
  document.getElementById('recommendations').textContent = analysis.recommendations;
  document.getElementById('confidence').textContent = (analysis.confidence || 0) + '%';
  document.getElementById('aiModel').textContent = analysis.aiModel || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
  document.getElementById('analysisResults').style.display = 'block';
}

function showAnalysisStatus(message, type = 'info') {
  console.log('showAnalysisStatus:', message, type);
  
  // Create status element if it doesn't exist
  let statusEl = document.querySelector('.body-analysis-form .status');
  if (!statusEl) {
    statusEl = document.createElement('div');
    statusEl.className = 'status';
    const form = document.querySelector('.body-analysis-form');
    if (form) {
      form.insertBefore(statusEl, form.querySelector('.analysis-history'));
    }
  }
  
  if (statusEl) {
    statusEl.className = `status ${type}`;
    statusEl.textContent = message;
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
      if (statusEl && statusEl.parentNode) {
        statusEl.remove();
      }
    }, 5000);
  } else {
    console.error('Could not create status element');
    alert(message); // Fallback
  }
}

async function saveAnalysis() {
  console.log('saveAnalysis called');
  console.log('currentAnalysis:', currentAnalysis);
  console.log('currentPhoto:', currentPhoto);
  
  if (!currentAnalysis || !currentPhoto) {
    console.log('Missing currentAnalysis or currentPhoto');
    showAnalysisStatus('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
    return;
  }

  try {
    console.log('Starting save process...');
    
    // Always save to localStorage first
    console.log('Saving to localStorage...');
    saveAnalysisToLocal(currentAnalysis);
    console.log('localStorage saved successfully');
    
    // Try to save analysis results to Yandex.Disk (without photo)
    let yandexSaved = false;
    if (appConfig.yandexToken) {
      try {
        console.log('Saving analysis to Yandex.Disk...');
        await saveAnalysisToYandex(currentAnalysis);
        console.log('Analysis saved to Yandex.Disk successfully');
        yandexSaved = true;
      } catch (yandexError) {
        console.warn('Yandex.Disk save failed:', yandexError);
      }
    } else {
      console.log('No Yandex token available');
    }
    
    if (yandexSaved) {
      showAnalysisStatus('–ê–Ω–∞–ª–∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫ –∏ –ª–æ–∫–∞–ª—å–Ω–æ!', 'success');
    } else if (appConfig.yandexToken) {
      showAnalysisStatus('–ê–Ω–∞–ª–∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ. –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫–æ–º.', 'info');
    } else {
      showAnalysisStatus('–ê–Ω–∞–ª–∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ. –î–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤–æ–π–¥–∏—Ç–µ –≤ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.', 'info');
    }
    
    loadAnalysisHistory();
    
  } catch (error) {
    console.error('Save error:', error);
    showAnalysisStatus('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message, 'error');
  }
}

async function savePhotoToYandex(photo) {
  console.log('savePhotoToYandex called');
  
  if (!appConfig.yandexToken) {
    throw new Error('–ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫–µ');
  }

  try {
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    const photoPath = `/MyFitness/photos/${timestamp}.jpg`;
    
    console.log('Photo path:', photoPath);
    
    // Convert base64 to blob
    console.log('Converting base64 to blob...');
    const response = await fetch(photo.dataUrl);
    const blob = await response.blob();
    console.log('Blob created, size:', blob.size);
    
    // Upload to Yandex.Disk
    console.log('Requesting upload URL...');
    const uploadResp = await fetch(`https://cloud-api.yandex.net/v1/disk/resources/upload?path=${encodeURIComponent(photoPath)}`, {
      headers: { 'Authorization': `OAuth ${appConfig.yandexToken}` }
    });
    
    console.log('Upload response status:', uploadResp.status);
    
    if (!uploadResp.ok) {
      const errorText = await uploadResp.text();
      console.error('Upload URL error:', uploadResp.status, errorText);
      throw new Error(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è URL –∑–∞–≥—Ä—É–∑–∫–∏: ${uploadResp.status}`);
    }
    
    const uploadData = await uploadResp.json();
    console.log('Upload data:', uploadData);
    
    if (!uploadData.href) {
      throw new Error('–ù–µ –ø–æ–ª—É—á–µ–Ω–∞ —Å—Å—ã–ª–∫–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏');
    }
    
    console.log('Uploading blob to Yandex.Disk...');
    const putResp = await fetch(uploadData.href, {
      method: 'PUT',
      body: blob
    });
    
    console.log('PUT response status:', putResp.status);
    
    if (!putResp.ok) {
      const errorText = await putResp.text();
      console.error('PUT error:', putResp.status, errorText);
      throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: ${putResp.status}`);
    }
    
    console.log('Photo uploaded successfully');
    
  } catch (error) {
    console.error('savePhotoToYandex error:', error);
    throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ: ${error.message}`);
  }
}

async function saveAnalysisToYandex(analysis) {
  console.log('saveAnalysisToYandex called');
  
  if (!appConfig.yandexToken) {
    console.log('No Yandex token available');
    return;
  }

  try {
    const analysisPath = `/MyFitness/body_analysis.json`;
    console.log('Analysis path:', analysisPath);
    
    // Load existing analyses
    let analyses = [];
    try {
      console.log('Checking if analysis file exists...');
      const checkResp = await fetch(`https://cloud-api.yandex.net/v1/disk/resources?path=${encodeURIComponent(analysisPath)}`, {
        headers: { 'Authorization': `OAuth ${appConfig.yandexToken}` }
      });
      
      console.log('Check response status:', checkResp.status);
      
      if (checkResp.ok) {
        console.log('File exists, downloading...');
        const downloadResp = await fetch(`https://cloud-api.yandex.net/v1/disk/resources/download?path=${encodeURIComponent(analysisPath)}`, {
          headers: { 'Authorization': `OAuth ${appConfig.yandexToken}` }
        });
        
        if (downloadResp.ok) {
          const { href } = await downloadResp.json();
          const response = await fetch(href);
          analyses = await response.json();
          console.log('Loaded existing analyses:', analyses.length);
        }
      } else {
        console.log('File does not exist, will create new');
      }
    } catch (e) {
      console.warn('Failed to load existing analyses:', e);
    }
    
    // Add new analysis
    analyses.push(analysis);
    console.log('Added new analysis, total:', analyses.length);
    
    // Save back to Yandex.Disk
    console.log('Uploading analysis file...');
    const uploadResp = await fetch(`https://cloud-api.yandex.net/v1/disk/resources/upload?path=${encodeURIComponent(analysisPath)}&overwrite=true`, {
      headers: { 'Authorization': `OAuth ${appConfig.yandexToken}` }
    });
    
    console.log('Upload response status:', uploadResp.status);
    
    if (uploadResp.ok) {
      const { href } = await uploadResp.json();
      console.log('Upload URL received, uploading data...');
      
      const putResp = await fetch(href, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(analyses, null, 2)
      });
      
      console.log('PUT response status:', putResp.status);
      
      if (putResp.ok) {
        console.log('Analysis saved to Yandex.Disk successfully');
      } else {
        throw new Error(`PUT failed: ${putResp.status}`);
      }
    } else {
      throw new Error(`Upload failed: ${uploadResp.status}`);
    }
    
  } catch (error) {
    console.error('saveAnalysisToYandex error:', error);
    throw new Error(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞: ${error.message}`);
  }
}

function saveAnalysisToLocal(analysis) {
  console.log('saveAnalysisToLocal called with:', analysis);
  const analyses = JSON.parse(localStorage.getItem('bodyAnalyses') || '[]');
  console.log('Existing analyses:', analyses);
  analyses.push(analysis);
  console.log('Updated analyses:', analyses);
  localStorage.setItem('bodyAnalyses', JSON.stringify(analyses));
  console.log('Saved to localStorage successfully');
}

function loadAnalysisHistory() {
  console.log('loadAnalysisHistory called');
  const analyses = JSON.parse(localStorage.getItem('bodyAnalyses') || '[]');
  console.log('Loaded analyses from localStorage:', analyses);
  const historyContainer = document.getElementById('analysisHistory');
  
  if (!historyContainer) {
    console.error('analysisHistory container not found');
    return;
  }
  
  if (analyses.length === 0) {
    console.log('No analyses found, showing empty message');
    historyContainer.innerHTML = '<p style="text-align: center; color: var(--muted);">–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ—Ä–µ–Ω–∏–π –ø—É—Å—Ç–∞</p>';
    return;
  }
  
  const recentAnalyses = analyses.slice(-5).reverse(); // Last 5, newest first
  console.log('Recent analyses to display:', recentAnalyses);
  
  historyContainer.innerHTML = recentAnalyses.map(analysis => {
    const date = new Date(analysis.timestamp);
    const formattedDate = date.toLocaleDateString('ru-RU', { 
      day: '2-digit', 
      month: '2-digit', 
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
    
    return `
      <div class="history-item">
        <div class="history-date">${formattedDate}</div>
        <div class="history-fat">${analysis.fatPercentage}% –∂–∏—Ä–∞</div>
      </div>
    `;
  }).join('');
  
  console.log('History updated successfully');
  
  // Update charts and stats
  updateProgressCharts(analyses);
}

// Chart variables
let fatProgressChart = null;

function updateProgressCharts(analyses) {
  console.log('updateProgressCharts called with:', analyses);
  
  if (analyses.length === 0) {
    console.log('No analyses to display in charts');
    return;
  }
  
  // Sort analyses by date (oldest first)
  const sortedAnalyses = analyses.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
  
  // Prepare chart data
  const chartData = sortedAnalyses.map(analysis => ({
    date: new Date(analysis.timestamp),
    fatPercentage: analysis.fatPercentage
  }));
  
  // Update statistics
  updateChartStats(chartData);
  
  // Create or update chart
  createFatProgressChart(chartData);
}

function updateChartStats(chartData) {
  console.log('updateChartStats called with:', chartData);
  
  if (chartData.length === 0) return;
  
  // Calculate average fat percentage
  const totalFat = chartData.reduce((sum, data) => sum + data.fatPercentage, 0);
  const avgFat = totalFat / chartData.length;
  
  // Calculate monthly change
  const monthlyChange = calculateMonthlyChange(chartData);
  
  // Update DOM elements
  const avgFatElement = document.getElementById('avgFatPercentage');
  const monthlyChangeElement = document.getElementById('monthlyChange');
  const totalMeasurementsElement = document.getElementById('totalMeasurements');
  
  if (avgFatElement) {
    avgFatElement.textContent = avgFat.toFixed(1) + '%';
  }
  
  if (monthlyChangeElement) {
    if (monthlyChange !== null) {
      const changeText = monthlyChange > 0 ? `+${monthlyChange.toFixed(1)}%` : `${monthlyChange.toFixed(1)}%`;
      monthlyChangeElement.textContent = changeText;
      monthlyChangeElement.style.color = monthlyChange > 0 ? '#ef4444' : '#22c55e';
    } else {
      monthlyChangeElement.textContent = '–ù/–î';
      monthlyChangeElement.style.color = 'var(--muted)';
    }
  }
  
  if (totalMeasurementsElement) {
    totalMeasurementsElement.textContent = chartData.length;
  }
}

function calculateMonthlyChange(chartData) {
  if (chartData.length < 2) return null;
  
  const now = new Date();
  const oneMonthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
  
  // Find measurements from last month and current month
  const lastMonthData = chartData.filter(data => data.date < oneMonthAgo);
  const currentMonthData = chartData.filter(data => data.date >= oneMonthAgo);
  
  if (lastMonthData.length === 0 || currentMonthData.length === 0) return null;
  
  const lastMonthAvg = lastMonthData.reduce((sum, data) => sum + data.fatPercentage, 0) / lastMonthData.length;
  const currentMonthAvg = currentMonthData.reduce((sum, data) => sum + data.fatPercentage, 0) / currentMonthData.length;
  
  return currentMonthAvg - lastMonthAvg;
}

function createFatProgressChart(chartData) {
  console.log('createFatProgressChart called with:', chartData);
  
  const ctx = document.getElementById('fatProgressChart');
  if (!ctx) {
    console.error('fatProgressChart canvas not found');
    return;
  }
  
  // Destroy existing chart if it exists
  if (fatProgressChart) {
    fatProgressChart.destroy();
  }
  
  // Prepare data for Chart.js
  const labels = chartData.map(data => {
    const date = data.date;
    return date.toLocaleDateString('ru-RU', { 
      day: '2-digit', 
      month: '2-digit' 
    });
  });
  
  const data = chartData.map(data => data.fatPercentage);
  
  // Create gradient for line
  const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 200);
  gradient.addColorStop(0, 'rgba(34, 197, 94, 0.8)');
  gradient.addColorStop(1, 'rgba(34, 197, 94, 0.1)');
  
  // Create chart
  fatProgressChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: '–ü—Ä–æ—Ü–µ–Ω—Ç –∂–∏—Ä–∞ (%)',
        data: data,
        borderColor: '#22c55e',
        backgroundColor: gradient,
        borderWidth: 3,
        fill: true,
        tension: 0.4,
        pointBackgroundColor: '#22c55e',
        pointBorderColor: '#ffffff',
        pointBorderWidth: 2,
        pointRadius: 6,
        pointHoverRadius: 8
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          titleColor: '#ffffff',
          bodyColor: '#ffffff',
          borderColor: '#22c55e',
          borderWidth: 1,
          cornerRadius: 8,
          displayColors: false,
          callbacks: {
            title: function(context) {
              return '–î–∞—Ç–∞: ' + context[0].label;
            },
            label: function(context) {
              return '–ü—Ä–æ—Ü–µ–Ω—Ç –∂–∏—Ä–∞: ' + context.parsed.y + '%';
            }
          }
        }
      },
      scales: {
        x: {
          grid: {
            color: 'rgba(148, 163, 184, 0.1)'
          },
          ticks: {
            color: 'var(--muted)',
            font: {
              size: 12
            }
          }
        },
        y: {
          beginAtZero: false,
          grid: {
            color: 'rgba(148, 163, 184, 0.1)'
          },
          ticks: {
            color: 'var(--muted)',
            font: {
              size: 12
            },
            callback: function(value) {
              return value + '%';
            }
          }
        }
      },
      interaction: {
        intersect: false,
        mode: 'index'
      },
      elements: {
        point: {
          hoverBackgroundColor: '#22c55e'
        }
      }
    }
  });
  
  console.log('Fat progress chart created successfully');
}
      
      // Test data functions
      function loadTestData() {
        const testWorkouts = [
          {
            date: new Date(2024, 11, 15).toISOString(),
            cycle: 1,
            week: 1,
            session: 1,
            exercises: [
              {
                group: '–ì—Ä—É–¥—å',
                exercise: '–ñ–∏–º –ª–µ–∂–∞',
                sets: [
                  { reps: 10, weight: 60 },
                  { reps: 8, weight: 65 },
                  { reps: 6, weight: 70 }
                ]
              }
            ]
          },
          {
            date: new Date(2024, 11, 17).toISOString(),
            cycle: 1,
            week: 1,
            session: 2,
            exercises: [
              {
                group: '–°–ø–∏–Ω–∞',
                exercise: '–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è',
                sets: [
                  { reps: 8, weight: 0 },
                  { reps: 6, weight: 0 },
                  { reps: 5, weight: 0 }
                ]
              }
            ]
          },
          {
            date: new Date(2024, 11, 20).toISOString(),
            cycle: 1,
            week: 2,
            session: 1,
            exercises: [
              {
                group: '–ù–æ–≥–∏',
                exercise: '–ü—Ä–∏—Å–µ–¥ —Å–æ —à—Ç–∞–Ω–≥–æ–π',
                sets: [
                  { reps: 12, weight: 80 },
                  { reps: 10, weight: 85 },
                  { reps: 8, weight: 90 }
                ]
              }
            ]
          },
          {
            date: new Date(2025, 0, 5).toISOString(),
            cycle: 2,
            week: 1,
            session: 1,
            exercises: [
              {
                group: '–ü–ª–µ—á–∏',
                exercise: '–†–∞–∑–≤–µ–¥–µ–Ω–∏–µ –≥–∞–Ω—Ç–µ–ª–µ–π –≤ —Å—Ç–æ—Ä–æ–Ω—ã',
                sets: [
                  { reps: 12, weight: 8 },
                  { reps: 10, weight: 10 },
                  { reps: 8, weight: 12 }
                ]
              }
            ]
          },
          {
            date: new Date(2025, 0, 7).toISOString(),
            cycle: 2,
            week: 1,
            session: 2,
            exercises: [
              {
                group: '–ë–∏—Ü–µ–ø—Å',
                exercise: '–•–∞–º–º–µ—Ä —Å –≥–∞–Ω—Ç–µ–ª—è–º–∏',
                sets: [
                  { reps: 12, weight: 12 },
                  { reps: 10, weight: 14 },
                  { reps: 8, weight: 16 }
                ]
              }
            ]
          }
        ];
        
        localStorage.setItem('workouts', JSON.stringify(testWorkouts));
        alert('–¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã! –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.');
      }
      
      function clearTestData() {
        localStorage.removeItem('workouts');
        alert('–¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã!');
        loadWelcomePage(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
      }
    </script>
    <script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function () {
    navigator.serviceWorker.register('./service-worker.js')
      .catch(function (e) { console.warn('SW registration failed', e); });
  });
}
</script>
  </body>
</html>
